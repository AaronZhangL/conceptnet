<html>
<head>
<title>csc.nl.mblem.trie</title>
</head>
<body>
csc.nl.mblem.trie
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 68 lines<br/>
Missed: 44 lines<br/>
Skipped 28 lines<br/>
Percent: 60 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>from collections import defaultdict</pre></div>
<div class="skip"><span class="num"><pre>  2</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  3</pre></span><pre>class Leaf(object):</pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>    existing = {}</pre></div>
<div class="cov"><span class="num"><pre>  5</pre></span><pre>    count = 0</pre></div>
<div class="cov"><span class="num"><pre>  6</pre></span><pre>    def __init__(self, add, delete, pos, inflections):</pre></div>
<div class="cov"><span class="num"><pre>  7</pre></span><pre>        self.add = add</pre></div>
<div class="cov"><span class="num"><pre>  8</pre></span><pre>        self.delete = delete</pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>        self.pos = pos</pre></div>
<div class="cov"><span class="num"><pre> 10</pre></span><pre>        self.inflections = inflections</pre></div>
<div class="cov"><span class="num"><pre> 11</pre></span><pre>        Leaf.existing[add, delete, pos, inflections] = self</pre></div>
<div class="cov"><span class="num"><pre> 12</pre></span><pre>        Leaf.count += 1</pre></div>
<div class="skip"><span class="num"><pre> 13</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 14</pre></span><pre>    @staticmethod</pre></div>
<div class="cov"><span class="num"><pre> 15</pre></span><pre>    def make(add, delete, pos, inflections):</pre></div>
<div class="nocov"><span class="num"><pre> 16</pre></span><pre>        if Leaf.existing.has_key((add, delete, pos, inflections)):</pre></div>
<div class="nocov"><span class="num"><pre> 17</pre></span><pre>            return Leaf.existing[add, delete, pos, inflections]</pre></div>
<div class="nocov"><span class="num"><pre> 18</pre></span><pre>        else:</pre></div>
<div class="nocov"><span class="num"><pre> 19</pre></span><pre>            return Leaf(add, delete, pos, inflections)</pre></div>
<div class="skip"><span class="num"><pre> 20</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 21</pre></span><pre>    @staticmethod</pre></div>
<div class="cov"><span class="num"><pre> 22</pre></span><pre>    def list_from_string(string):</pre></div>
<div class="nocov"><span class="num"><pre> 23</pre></span><pre>        got = []</pre></div>
<div class="nocov"><span class="num"><pre> 24</pre></span><pre>        responses = string.split('|')</pre></div>
<div class="nocov"><span class="num"><pre> 25</pre></span><pre>        for response in responses:</pre></div>
<div class="nocov"><span class="num"><pre> 26</pre></span><pre>            insert = ''</pre></div>
<div class="nocov"><span class="num"><pre> 27</pre></span><pre>            delete = ''</pre></div>
<div class="nocov"><span class="num"><pre> 28</pre></span><pre>            parts = response.split('+')</pre></div>
<div class="nocov"><span class="num"><pre> 29</pre></span><pre>            try:</pre></div>
<div class="nocov"><span class="num"><pre> 30</pre></span><pre>                pos, infl = parts[0].split('-')</pre></div>
<div class="nocov"><span class="num"><pre> 31</pre></span><pre>                for part in parts[1:]:</pre></div>
<div class="nocov"><span class="num"><pre> 32</pre></span><pre>                    if part.startswith('D'):</pre></div>
<div class="nocov"><span class="num"><pre> 33</pre></span><pre>                        delete = part[1:]</pre></div>
<div class="nocov"><span class="num"><pre> 34</pre></span><pre>                    elif part.startswith('I'):</pre></div>
<div class="nocov"><span class="num"><pre> 35</pre></span><pre>                        insert = part[1:]</pre></div>
<div class="nocov"><span class="num"><pre> 36</pre></span><pre>            except ValueError:</pre></div>
<div class="nocov"><span class="num"><pre> 37</pre></span><pre>                if len(parts) == 2: # unlemmatizing format</pre></div>
<div class="nocov"><span class="num"><pre> 38</pre></span><pre>                    delete, insert = parts</pre></div>
<div class="nocov"><span class="num"><pre> 39</pre></span><pre>                    pos = infl = None</pre></div>
<div class="nocov"><span class="num"><pre> 40</pre></span><pre>                else: raise</pre></div>
<div class="nocov"><span class="num"><pre> 41</pre></span><pre>            got.append(Leaf.make(insert, delete, pos, infl))</pre></div>
<div class="nocov"><span class="num"><pre> 42</pre></span><pre>        return got</pre></div>
<div class="skip"><span class="num"><pre> 43</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 44</pre></span><pre>    def apply(self, string):</pre></div>
<div class="cov"><span class="num"><pre> 45</pre></span><pre>        if len(self.delete) == 0:</pre></div>
<div class="cov"><span class="num"><pre> 46</pre></span><pre>            stem = string</pre></div>
<div class="skip"><span class="num"><pre> 47</pre></span><pre>        #elif string.endswith(self.delete):</pre></div>
<div class="cov"><span class="num"><pre> 48</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre> 49</pre></span><pre>            stem = string[:-len(self.delete)]</pre></div>
<div class="skip"><span class="num"><pre> 50</pre></span><pre>        #else:</pre></div>
<div class="skip"><span class="num"><pre> 51</pre></span><pre>        #    stem = string+'?'</pre></div>
<div class="cov"><span class="num"><pre> 52</pre></span><pre>        return (stem + self.add, self.pos, self.inflections)</pre></div>
<div class="skip"><span class="num"><pre> 53</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 54</pre></span><pre>    def __repr__(self):</pre></div>
<div class="nocov"><span class="num"><pre> 55</pre></span><pre>        if self.add: addstr = &quot; +%s&quot; % self.add</pre></div>
<div class="nocov"><span class="num"><pre> 56</pre></span><pre>        else: addstr = ''</pre></div>
<div class="nocov"><span class="num"><pre> 57</pre></span><pre>        if self.delete: delstr = &quot; -%s&quot; % self.delete</pre></div>
<div class="nocov"><span class="num"><pre> 58</pre></span><pre>        else: delstr = ''</pre></div>
<div class="nocov"><span class="num"><pre> 59</pre></span><pre>        return &quot;&lt;Leaf%s%s (%s.%s)&gt;&quot; % (addstr, delstr, self.pos,</pre></div>
<div class="nocov"><span class="num"><pre> 60</pre></span><pre>        self.inflections)</pre></div>
<div class="skip"><span class="num"><pre> 61</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 62</pre></span><pre>    def symbol(self):</pre></div>
<div class="nocov"><span class="num"><pre> 63</pre></span><pre>        return u&quot;%s.%s.%s.%s&quot; % (self.pos, self.inflections, self.add, self.delete)</pre></div>
<div class="skip"><span class="num"><pre> 64</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 65</pre></span><pre>POS_ORDER = ['TO', 'ART', 'V', 'N', 'A', 'ADV', 'PREP', 'PRON', 'C', 'ABB']</pre></div>
<div class="skip"><span class="num"><pre> 66</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 67</pre></span><pre>def pos_order(pos):</pre></div>
<div class="cov"><span class="num"><pre> 68</pre></span><pre>    if pos in POS_ORDER: return POS_ORDER.index(pos)</pre></div>
<div class="cov"><span class="num"><pre> 69</pre></span><pre>    else: return 100</pre></div>
<div class="skip"><span class="num"><pre> 70</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 71</pre></span><pre>def israre(infl):</pre></div>
<div class="cov"><span class="num"><pre> 72</pre></span><pre>    return isinstance(infl, basestring) and (infl.endswith('r') or infl == 'pa')</pre></div>
<div class="skip"><span class="num"><pre> 73</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 74</pre></span><pre>class Node(object):</pre></div>
<div class="cov"><span class="num"><pre> 75</pre></span><pre>    def __init__(self, trie=None, leaves=None):</pre></div>
<div class="cov"><span class="num"><pre> 76</pre></span><pre>        self.trie = trie or {}</pre></div>
<div class="cov"><span class="num"><pre> 77</pre></span><pre>        self.leaf_index = defaultdict(list)</pre></div>
<div class="cov"><span class="num"><pre> 78</pre></span><pre>        if leaves is not None:</pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>            for leaf in leaves:</pre></div>
<div class="cov"><span class="num"><pre> 80</pre></span><pre>                self.leaf_index[leaf.pos, leaf.inflections].append(leaf)</pre></div>
<div class="skip"><span class="num"><pre> 81</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 82</pre></span><pre>    def add_leaf(self, leaf):</pre></div>
<div class="nocov"><span class="num"><pre> 83</pre></span><pre>        self.leaf_index[leaf.pos, leaf.inflections].append(leaf)</pre></div>
<div class="skip"><span class="num"><pre> 84</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 85</pre></span><pre>    def leaves(self):</pre></div>
<div class="cov"><span class="num"><pre> 86</pre></span><pre>        result = []</pre></div>
<div class="cov"><span class="num"><pre> 87</pre></span><pre>        for leaflist in self.leaf_index.values():</pre></div>
<div class="cov"><span class="num"><pre> 88</pre></span><pre>            result.extend(leaflist)</pre></div>
<div class="skip"><span class="num"><pre> 89</pre></span><pre>        # ignore rare/archaic inflections</pre></div>
<div class="cov"><span class="num"><pre> 90</pre></span><pre>        result = [leaf for leaf in result if not israre(leaf.inflections)]</pre></div>
<div class="cov"><span class="num"><pre> 91</pre></span><pre>        result.sort(key=lambda leaf: (pos_order(leaf.pos),</pre></div>
<div class="cov"><span class="num"><pre> 92</pre></span><pre>          -10*len(leaf.delete)+len(leaf.add)))</pre></div>
<div class="cov"><span class="num"><pre> 93</pre></span><pre>        return result</pre></div>
<div class="skip"><span class="num"><pre> 94</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 95</pre></span><pre>    def add(self, key, leaf):</pre></div>
<div class="nocov"><span class="num"><pre> 96</pre></span><pre>        if len(key) == 0: self.add_leaf(leaf)</pre></div>
<div class="nocov"><span class="num"><pre> 97</pre></span><pre>        else:</pre></div>
<div class="nocov"><span class="num"><pre> 98</pre></span><pre>            start = key[0]</pre></div>
<div class="nocov"><span class="num"><pre> 99</pre></span><pre>            trie = self.trie.setdefault(start, Node())</pre></div>
<div class="nocov"><span class="num"><pre>100</pre></span><pre>            trie.add(key[1:], leaf)</pre></div>
<div class="skip"><span class="num"><pre>101</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>102</pre></span><pre>    def lookup(self, seq, pos=None, infl=None):</pre></div>
<div class="cov"><span class="num"><pre>103</pre></span><pre>        if len(seq) == 0: key = '='</pre></div>
<div class="cov"><span class="num"><pre>104</pre></span><pre>        else: key = seq[0]</pre></div>
<div class="skip"><span class="num"><pre>105</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>106</pre></span><pre>        if key in self.trie:</pre></div>
<div class="cov"><span class="num"><pre>107</pre></span><pre>            return self.trie[key].lookup(seq[1:], pos, infl)</pre></div>
<div class="cov"><span class="num"><pre>108</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre>109</pre></span><pre>            return self.leaves()</pre></div>
<div class="skip"><span class="num"><pre>110</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>111</pre></span><pre>    def permute(self, string):</pre></div>
<div class="cov"><span class="num"><pre>112</pre></span><pre>        padded = '='*(20-len(string)) + string</pre></div>
<div class="cov"><span class="num"><pre>113</pre></span><pre>        if hasattr(self, 'permutation'):</pre></div>
<div class="cov"><span class="num"><pre>114</pre></span><pre>            return [padded[i] for i in self.permutation]</pre></div>
<div class="nocov"><span class="num"><pre>115</pre></span><pre>        else:</pre></div>
<div class="nocov"><span class="num"><pre>116</pre></span><pre>            return list(string[::-1])</pre></div>
<div class="skip"><span class="num"><pre>117</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>118</pre></span><pre>    def mblem(self, string, pos=None, infl=None):</pre></div>
<div class="cov"><span class="num"><pre>119</pre></span><pre>        seq = self.permute(string)</pre></div>
<div class="cov"><span class="num"><pre>120</pre></span><pre>        leaves = self.lookup(seq, pos, infl)</pre></div>
<div class="cov"><span class="num"><pre>121</pre></span><pre>        return [leaf.apply(string) for leaf in leaves]</pre></div>
<div class="skip"><span class="num"><pre>122</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>123</pre></span><pre>    def unlem(self, string):</pre></div>
<div class="cov"><span class="num"><pre>124</pre></span><pre>        leaves = self.lookup(string[::-1])</pre></div>
<div class="cov"><span class="num"><pre>125</pre></span><pre>        return [leaf.apply(string)[0] for leaf in leaves]</pre></div>
<div class="skip"><span class="num"><pre>126</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>127</pre></span><pre>    def walk(self, suffix):</pre></div>
<div class="nocov"><span class="num"><pre>128</pre></span><pre>        out = [(self, suffix)]</pre></div>
<div class="nocov"><span class="num"><pre>129</pre></span><pre>        for key in self.trie:</pre></div>
<div class="nocov"><span class="num"><pre>130</pre></span><pre>            out.extend(self.trie[key].walk(key+suffix))</pre></div>
<div class="nocov"><span class="num"><pre>131</pre></span><pre>        return out</pre></div>
<div class="skip"><span class="num"><pre>132</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>133</pre></span><pre>    def __repr__(self):</pre></div>
<div class="nocov"><span class="num"><pre>134</pre></span><pre>        return &quot;&lt;Trie node: [%s]&gt;&quot; % (''.join(sorted(self.trie.keys())))</pre></div>
<div class="skip"><span class="num"><pre>135</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>136</pre></span><pre>def default_trie():</pre></div>
<div class="cov"><span class="num"><pre>137</pre></span><pre>    return Node(leaves=[Leaf('', '', None, None)])</pre></div>
<div class="skip"><span class="num"><pre>138</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>139</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>140</pre></span><pre></pre></div>
</div>
</body>
</html>
