<html>
<head>
<title>csc.conceptnet4.models</title>
</head>
<body>
csc.conceptnet4.models
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 423 lines<br/>
Missed: 423 lines<br/>
Skipped 173 lines<br/>
Percent: 50 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>   1</pre></span><pre>__version__ = &quot;4.0b2&quot;</pre></div>
<div class="cov"><span class="num"><pre>   2</pre></span><pre>from django.db import models</pre></div>
<div class="cov"><span class="num"><pre>   3</pre></span><pre>from django.db.models import Q</pre></div>
<div class="cov"><span class="num"><pre>   4</pre></span><pre>from csc.corpus.models import Language, Sentence, User, ScoredModel</pre></div>
<div class="cov"><span class="num"><pre>   5</pre></span><pre>from csc.nl.models import Frequency</pre></div>
<div class="cov"><span class="num"><pre>   6</pre></span><pre>from events.models import Event, Activity</pre></div>
<div class="cov"><span class="num"><pre>   7</pre></span><pre>from voting.models import Vote</pre></div>
<div class="cov"><span class="num"><pre>   8</pre></span><pre>from django.contrib.contenttypes import generic</pre></div>
<div class="cov"><span class="num"><pre>   9</pre></span><pre>from csc.util import cached</pre></div>
<div class="cov"><span class="num"><pre>  10</pre></span><pre>from datetime import datetime</pre></div>
<div class="cov"><span class="num"><pre>  11</pre></span><pre>from urllib import quote as urlquote</pre></div>
<div class="cov"><span class="num"><pre>  12</pre></span><pre>import re</pre></div>
<div class="skip"><span class="num"><pre>  13</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  14</pre></span><pre>DEFAULT_LANGUAGE = en = Language(id='en', name='English') </pre></div>
<div class="cov"><span class="num"><pre>  15</pre></span><pre>CURRENT_THREAD_REVISION = 6</pre></div>
<div class="skip"><span class="num"><pre>  16</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  17</pre></span><pre>class TimestampedModel(models.Model):</pre></div>
<div class="cov"><span class="num"><pre>  18</pre></span><pre>    created = models.DateTimeField(default=datetime.now)</pre></div>
<div class="cov"><span class="num"><pre>  19</pre></span><pre>    updated = models.DateTimeField()</pre></div>
<div class="skip"><span class="num"><pre>  20</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>  21</pre></span><pre>    def save(self, **kwargs):</pre></div>
<div class="nocov"><span class="num"><pre>  22</pre></span><pre>        self.updated = datetime.now()</pre></div>
<div class="nocov"><span class="num"><pre>  23</pre></span><pre>        super(TimestampedModel, self).save(**kwargs)</pre></div>
<div class="skip"><span class="num"><pre>  24</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  25</pre></span><pre>    class Meta:</pre></div>
<div class="cov"><span class="num"><pre>  26</pre></span><pre>        abstract = True</pre></div>
<div class="skip"><span class="num"><pre>  27</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  28</pre></span><pre>class UserData(TimestampedModel):</pre></div>
<div class="cov"><span class="num"><pre>  29</pre></span><pre>    user = models.ForeignKey(User)</pre></div>
<div class="cov"><span class="num"><pre>  30</pre></span><pre>    activity = models.ForeignKey(Activity)</pre></div>
<div class="skip"><span class="num"><pre>  31</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  32</pre></span><pre>class Batch(TimestampedModel):</pre></div>
<div class="cov"><span class="num"><pre>  33</pre></span><pre>    owner = models.ForeignKey(User)</pre></div>
<div class="cov"><span class="num"><pre>  34</pre></span><pre>    status = models.CharField(max_length=255,blank=True)</pre></div>
<div class="cov"><span class="num"><pre>  35</pre></span><pre>    remarks = models.TextField(blank=True)</pre></div>
<div class="cov"><span class="num"><pre>  36</pre></span><pre>    progress_num = models.IntegerField(default=0)</pre></div>
<div class="cov"><span class="num"><pre>  37</pre></span><pre>    progress_den = models.IntegerField(default=0)</pre></div>
<div class="skip"><span class="num"><pre>  38</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  39</pre></span><pre>    def __unicode__(self):</pre></div>
<div class="nocov"><span class="num"><pre>  40</pre></span><pre>        return u&quot;Batch &quot; + str(self.id) + &quot; (owner: &quot; + self.owner.username + &quot;) &lt;&quot; + str(self.progress_num) + &quot;/&quot; + str(self.progress_den) + &quot; &quot; + self.status + &quot;&gt;&quot;</pre></div>
<div class="skip"><span class="num"><pre>  41</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  42</pre></span><pre>    class Meta:</pre></div>
<div class="cov"><span class="num"><pre>  43</pre></span><pre>        db_table = 'parsing_batch'</pre></div>
<div class="skip"><span class="num"><pre>  44</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  45</pre></span><pre>class Relation(models.Model):</pre></div>
<div class="cov"><span class="num"><pre>  46</pre></span><pre>    name = models.CharField(max_length=128,unique=True)</pre></div>
<div class="cov"><span class="num"><pre>  47</pre></span><pre>    description = models.CharField(max_length=255, null=True, blank=True)</pre></div>
<div class="skip"><span class="num"><pre>  48</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  49</pre></span><pre>    def __unicode__(self):</pre></div>
<div class="nocov"><span class="num"><pre>  50</pre></span><pre>        return self.name</pre></div>
<div class="skip"><span class="num"><pre>  51</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  52</pre></span><pre>    @classmethod</pre></div>
<div class="cov"><span class="num"><pre>  53</pre></span><pre>    def get(cls, name):</pre></div>
<div class="skip"><span class="num"><pre>  54</pre></span><pre>        # Check if the parameter is already a Relation. We don't use</pre></div>
<div class="skip"><span class="num"><pre>  55</pre></span><pre>        # isinstance in case of accidental multiple imports (e.g.,</pre></div>
<div class="skip"><span class="num"><pre>  56</pre></span><pre>        # csc.conceptnet4.models vs conceptnet4.models).</pre></div>
<div class="nocov"><span class="num"><pre>  57</pre></span><pre>        if hasattr(name, 'id'):</pre></div>
<div class="nocov"><span class="num"><pre>  58</pre></span><pre>            return name</pre></div>
<div class="nocov"><span class="num"><pre>  59</pre></span><pre>        return cls.objects.get(name=name)</pre></div>
<div class="skip"><span class="num"><pre>  60</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>  61</pre></span><pre>    class Meta:</pre></div>
<div class="cov"><span class="num"><pre>  62</pre></span><pre>        db_table = 'predicatetypes' # an antiquated name.</pre></div>
<div class="skip"><span class="num"><pre>  63</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  64</pre></span><pre>class Frame(models.Model):</pre></div>
<div class="cov"><span class="num"><pre>  65</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  66</pre></span><pre>    A Frame is a natural-language template containing two slots, representing a</pre></div>
<div class="cov"><span class="num"><pre>  67</pre></span><pre>    way that a :class:`Relation` could be expressed in language.</pre></div>
<div class="skip"><span class="num"><pre>  68</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>  69</pre></span><pre>    It can be used</pre></div>
<div class="cov"><span class="num"><pre>  70</pre></span><pre>    for pattern matching to create a :class:`RawAssertion`, or to express an</pre></div>
<div class="cov"><span class="num"><pre>  71</pre></span><pre>    existing :class:`RawAssertion` as a sentence.</pre></div>
<div class="cov"><span class="num"><pre>  72</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  73</pre></span><pre>    language = models.ForeignKey(Language)</pre></div>
<div class="cov"><span class="num"><pre>  74</pre></span><pre>    text = models.TextField()</pre></div>
<div class="cov"><span class="num"><pre>  75</pre></span><pre>    relation = models.ForeignKey(Relation)</pre></div>
<div class="cov"><span class="num"><pre>  76</pre></span><pre>    goodness = models.IntegerField()</pre></div>
<div class="cov"><span class="num"><pre>  77</pre></span><pre>    frequency = models.ForeignKey(Frequency)</pre></div>
<div class="cov"><span class="num"><pre>  78</pre></span><pre>    question_yn = models.TextField(null=True, blank=True)</pre></div>
<div class="cov"><span class="num"><pre>  79</pre></span><pre>    question1 = models.TextField(null=True, blank=True)</pre></div>
<div class="cov"><span class="num"><pre>  80</pre></span><pre>    question2 = models.TextField(null=True, blank=True)</pre></div>
<div class="skip"><span class="num"><pre>  81</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  82</pre></span><pre>    def preferred(self):</pre></div>
<div class="nocov"><span class="num"><pre>  83</pre></span><pre>        return self.goodness &gt; 2</pre></div>
<div class="cov"><span class="num"><pre>  84</pre></span><pre>    preferred.boolean = True</pre></div>
<div class="skip"><span class="num"><pre>  85</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>  86</pre></span><pre>    def fill_in(self, a, b):</pre></div>
<div class="cov"><span class="num"><pre>  87</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  88</pre></span><pre>        Fill in the slots of this frame with the strings *a* and *b*.</pre></div>
<div class="cov"><span class="num"><pre>  89</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>  90</pre></span><pre>        res = self.text.replace('{%}', '')</pre></div>
<div class="nocov"><span class="num"><pre>  91</pre></span><pre>        res = res.replace('{1}', a, 1)</pre></div>
<div class="nocov"><span class="num"><pre>  92</pre></span><pre>        return res.replace('{2}', b, 1)</pre></div>
<div class="skip"><span class="num"><pre>  93</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  94</pre></span><pre>    def __unicode__(self):</pre></div>
<div class="nocov"><span class="num"><pre>  95</pre></span><pre>        return &quot;%s (%s)&quot; % (self.text, self.language.id)</pre></div>
<div class="cov"><span class="num"><pre>  96</pre></span><pre>    def re_pattern(self):</pre></div>
<div class="nocov"><span class="num"><pre>  97</pre></span><pre>        if not hasattr(self, '_re_pattern'):</pre></div>
<div class="nocov"><span class="num"><pre>  98</pre></span><pre>            self._re_pattern = re.compile(self.text.replace('{%}',</pre></div>
<div class="nocov"><span class="num"><pre>  99</pre></span><pre>            '').replace('{1}', '(.+)').replace('{2}', '(.+)').strip('. '))</pre></div>
<div class="nocov"><span class="num"><pre> 100</pre></span><pre>        return self._re_pattern</pre></div>
<div class="cov"><span class="num"><pre> 101</pre></span><pre>    def match(self, text):</pre></div>
<div class="nocov"><span class="num"><pre> 102</pre></span><pre>        match = self.re_pattern().match(text)</pre></div>
<div class="nocov"><span class="num"><pre> 103</pre></span><pre>        if match:</pre></div>
<div class="nocov"><span class="num"><pre> 104</pre></span><pre>            return match.groups()</pre></div>
<div class="nocov"><span class="num"><pre> 105</pre></span><pre>        else: return None</pre></div>
<div class="cov"><span class="num"><pre> 106</pre></span><pre>    def display(self):</pre></div>
<div class="nocov"><span class="num"><pre> 107</pre></span><pre>        return self.fill_in('...', '...')</pre></div>
<div class="skip"><span class="num"><pre> 108</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 109</pre></span><pre>    @staticmethod</pre></div>
<div class="cov"><span class="num"><pre> 110</pre></span><pre>    def match_sentence(text, language):</pre></div>
<div class="nocov"><span class="num"><pre> 111</pre></span><pre>        text = text.strip('. ')</pre></div>
<div class="nocov"><span class="num"><pre> 112</pre></span><pre>        for frame in Frame.objects.filter(language=language,</pre></div>
<div class="nocov"><span class="num"><pre> 113</pre></span><pre>        goodness__gte=2).order_by('-goodness'):</pre></div>
<div class="nocov"><span class="num"><pre> 114</pre></span><pre>            result = frame.match(text)</pre></div>
<div class="nocov"><span class="num"><pre> 115</pre></span><pre>            if result:</pre></div>
<div class="nocov"><span class="num"><pre> 116</pre></span><pre>                return frame, result</pre></div>
<div class="nocov"><span class="num"><pre> 117</pre></span><pre>        return None</pre></div>
<div class="skip"><span class="num"><pre> 118</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 119</pre></span><pre>    class Meta:</pre></div>
<div class="cov"><span class="num"><pre> 120</pre></span><pre>        db_table = 'conceptnet_frames'</pre></div>
<div class="skip"><span class="num"><pre> 121</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 122</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 123</pre></span><pre>class Feature(object):</pre></div>
<div class="cov"><span class="num"><pre> 124</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 125</pre></span><pre>    Features are not models in the database, but they are useful ways to</pre></div>
<div class="cov"><span class="num"><pre> 126</pre></span><pre>    describe the knowledge contained in the edges of ConceptNet.</pre></div>
<div class="skip"><span class="num"><pre> 127</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 128</pre></span><pre>    A Feature is the combination of a :class:`Concept` and a :class:`Relation`.</pre></div>
<div class="cov"><span class="num"><pre> 129</pre></span><pre>    The combination of a Concept and a Feature, then, gives a</pre></div>
<div class="cov"><span class="num"><pre> 130</pre></span><pre>    :class:`Proposition`, a statement that can have a truth value; when given a</pre></div>
<div class="cov"><span class="num"><pre> 131</pre></span><pre>    truth value, this forms an :class:`Assertion`.</pre></div>
<div class="skip"><span class="num"><pre> 132</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 133</pre></span><pre>    As an example, the relation ``PartOf(cello, orchestra)`` breaks down into</pre></div>
<div class="cov"><span class="num"><pre> 134</pre></span><pre>    the concept ``cello`` and the feature ``PartOf(x, orchestra)``. It also</pre></div>
<div class="cov"><span class="num"><pre> 135</pre></span><pre>    breaks down into ``orchestra`` and ``PartOf(cello, x)``.</pre></div>
<div class="skip"><span class="num"><pre> 136</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 137</pre></span><pre>    Features can be *left features* or *right features*, depending on whether</pre></div>
<div class="cov"><span class="num"><pre> 138</pre></span><pre>    they include the left or right concept (that is, the first or second</pre></div>
<div class="cov"><span class="num"><pre> 139</pre></span><pre>    argument) in the Assertion. The Feature class itself is an abstract class,</pre></div>
<div class="cov"><span class="num"><pre> 140</pre></span><pre>    which is realized in the classes :class:`LeftFeature` and</pre></div>
<div class="cov"><span class="num"><pre> 141</pre></span><pre>    :class:`RightFeature`.</pre></div>
<div class="skip"><span class="num"><pre> 142</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 143</pre></span><pre>    Each Assertion can be described with its</pre></div>
<div class="cov"><span class="num"><pre> 144</pre></span><pre>    left concept (:attr:`concept1`) and its right feature, or its right concept</pre></div>
<div class="cov"><span class="num"><pre> 145</pre></span><pre>    (:attr:`concept2`) and its left feature.</pre></div>
<div class="skip"><span class="num"><pre> 146</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 147</pre></span><pre>    The notation is based on putting the relation in a &quot;bucket&quot;. For</pre></div>
<div class="cov"><span class="num"><pre> 148</pre></span><pre>    example, ``PartOf(cello, orchestra) =</pre></div>
<div class="cov"><span class="num"><pre> 149</pre></span><pre>    cello\PartOf/orchestra``. Breaking this apart gives left and right</pre></div>
<div class="cov"><span class="num"><pre> 150</pre></span><pre>    features::</pre></div>
<div class="skip"><span class="num"><pre> 151</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 152</pre></span><pre>      cello: PartOf/orchestra (left concept and right feature)</pre></div>
<div class="cov"><span class="num"><pre> 153</pre></span><pre>      orchestra: cello\PartOf (right concept and left feature)</pre></div>
<div class="skip"><span class="num"><pre> 154</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre> 155</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre> 156</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 157</pre></span><pre>    def __init__(self, relation, concept):</pre></div>
<div class="cov"><span class="num"><pre> 158</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 159</pre></span><pre>        Create a LeftFeature or RightFeature (depending on which class you</pre></div>
<div class="cov"><span class="num"><pre> 160</pre></span><pre>        instantiate), with the given relation and concept.</pre></div>
<div class="cov"><span class="num"><pre> 161</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 162</pre></span><pre>        if self.__class__ == Feature:</pre></div>
<div class="nocov"><span class="num"><pre> 163</pre></span><pre>            raise NotImplementedError(&quot;Feature is an abstract class&quot;)</pre></div>
<div class="nocov"><span class="num"><pre> 164</pre></span><pre>        if isinstance(relation, basestring):</pre></div>
<div class="nocov"><span class="num"><pre> 165</pre></span><pre>            relation = Relation.objects.get(name=relation)</pre></div>
<div class="skip"><span class="num"><pre> 166</pre></span><pre>        #if isinstance(concept, basestring):</pre></div>
<div class="skip"><span class="num"><pre> 167</pre></span><pre>        #    concept = Concept.get(concept, auto_create=True)</pre></div>
<div class="nocov"><span class="num"><pre> 168</pre></span><pre>        self.relation = relation</pre></div>
<div class="nocov"><span class="num"><pre> 169</pre></span><pre>        self.concept = concept</pre></div>
<div class="skip"><span class="num"><pre> 170</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 171</pre></span><pre>    def to_tuple(self):</pre></div>
<div class="nocov"><span class="num"><pre> 172</pre></span><pre>        return (self.tuple_key, self.relation.name, self.concept.text)</pre></div>
<div class="cov"><span class="num"><pre> 173</pre></span><pre>    @property</pre></div>
<div class="cov"><span class="num"><pre> 174</pre></span><pre>    def language(self):</pre></div>
<div class="nocov"><span class="num"><pre> 175</pre></span><pre>        return self.concept.language</pre></div>
<div class="cov"><span class="num"><pre> 176</pre></span><pre>    def __hash__(self): # Features should be immutable.</pre></div>
<div class="nocov"><span class="num"><pre> 177</pre></span><pre>        return hash((self.__class__.__name__, self.relation, self.concept))</pre></div>
<div class="cov"><span class="num"><pre> 178</pre></span><pre>    def __cmp__(self, other):</pre></div>
<div class="nocov"><span class="num"><pre> 179</pre></span><pre>        if not isinstance(other, Feature): return -1</pre></div>
<div class="nocov"><span class="num"><pre> 180</pre></span><pre>        return cmp((self.__class__, self.relation, self.concept),</pre></div>
<div class="nocov"><span class="num"><pre> 181</pre></span><pre>                   (other.__class__, other.relation, other.concept))</pre></div>
<div class="cov"><span class="num"><pre> 182</pre></span><pre>    @staticmethod</pre></div>
<div class="cov"><span class="num"><pre> 183</pre></span><pre>    def from_tuple(tup, lang=DEFAULT_LANGUAGE, lemmatize=False):</pre></div>
<div class="cov"><span class="num"><pre> 184</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 185</pre></span><pre>        Some systems such as AnalogySpace use a lower-level representation of</pre></div>
<div class="cov"><span class="num"><pre> 186</pre></span><pre>        features, representing them as a tuple of three strings:</pre></div>
<div class="cov"><span class="num"><pre> 187</pre></span><pre>        ``(left_or_right, relation, concept)``. This factory method takes in</pre></div>
<div class="cov"><span class="num"><pre> 188</pre></span><pre>        such a tuple and produces a proper Feature object.</pre></div>
<div class="cov"><span class="num"><pre> 189</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 190</pre></span><pre>        typ, rel, txt = tup</pre></div>
<div class="nocov"><span class="num"><pre> 191</pre></span><pre>        if lemmatize:</pre></div>
<div class="nocov"><span class="num"><pre> 192</pre></span><pre>            c = Concept.get(txt, lang)</pre></div>
<div class="nocov"><span class="num"><pre> 193</pre></span><pre>        else:</pre></div>
<div class="nocov"><span class="num"><pre> 194</pre></span><pre>            c, _ = Concept.objects.get_or_create(text=txt, language=lang)</pre></div>
<div class="nocov"><span class="num"><pre> 195</pre></span><pre>        r = Relation.objects.get(name=rel)</pre></div>
<div class="nocov"><span class="num"><pre> 196</pre></span><pre>        return Feature.from_obj_tuple(typ, r, c)</pre></div>
<div class="cov"><span class="num"><pre> 197</pre></span><pre>    @staticmethod</pre></div>
<div class="cov"><span class="num"><pre> 198</pre></span><pre>    def from_obj_tuple(typ, relation, concept):</pre></div>
<div class="nocov"><span class="num"><pre> 199</pre></span><pre>        classes = {'left': LeftFeature, 'right': RightFeature}</pre></div>
<div class="nocov"><span class="num"><pre> 200</pre></span><pre>        if typ not in classes: raise ValueError</pre></div>
<div class="nocov"><span class="num"><pre> 201</pre></span><pre>        return classes[typ](relation, concept)</pre></div>
<div class="skip"><span class="num"><pre> 202</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 203</pre></span><pre>    @property</pre></div>
<div class="cov"><span class="num"><pre> 204</pre></span><pre>    def frame(self):</pre></div>
<div class="cov"><span class="num"><pre> 205</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 206</pre></span><pre>        Get a good natural-language frame for expressing this feature. For</pre></div>
<div class="cov"><span class="num"><pre> 207</pre></span><pre>        backward compatibility, this is a property.</pre></div>
<div class="cov"><span class="num"><pre> 208</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 209</pre></span><pre>        return Frame.objects.filter(language=self.language,</pre></div>
<div class="nocov"><span class="num"><pre> 210</pre></span><pre>                                    relation=self.relation).order_by('-goodness')[0]</pre></div>
<div class="cov"><span class="num"><pre> 211</pre></span><pre>    def fill_in(self, newconcept):</pre></div>
<div class="cov"><span class="num"><pre> 212</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 213</pre></span><pre>        Fill in the blank of this feature with a :class:`Concept`. The result</pre></div>
<div class="cov"><span class="num"><pre> 214</pre></span><pre>        is a :class:`Proposition`.</pre></div>
<div class="cov"><span class="num"><pre> 215</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 216</pre></span><pre>        raise NotImplementedError, &quot;Feature is an abstract class&quot;</pre></div>
<div class="cov"><span class="num"><pre> 217</pre></span><pre>    def matching_assertions(self):</pre></div>
<div class="cov"><span class="num"><pre> 218</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 219</pre></span><pre>        Get all :class:`Assertions` that contain this feature.</pre></div>
<div class="cov"><span class="num"><pre> 220</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 221</pre></span><pre>        raise NotImplementedError, &quot;Feature is an abstract class&quot;</pre></div>
<div class="cov"><span class="num"><pre> 222</pre></span><pre>    def matching_raw(self):</pre></div>
<div class="cov"><span class="num"><pre> 223</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 224</pre></span><pre>        Get all :class:`RawAssertions` that contain this feature.</pre></div>
<div class="cov"><span class="num"><pre> 225</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 226</pre></span><pre>        raise NotImplementedError, &quot;Feature is an abstract class&quot;</pre></div>
<div class="cov"><span class="num"><pre> 227</pre></span><pre>    def nl_frame(self, gap=None):</pre></div>
<div class="cov"><span class="num"><pre> 228</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 229</pre></span><pre>        This code is kinda confused.</pre></div>
<div class="cov"><span class="num"><pre> 230</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 231</pre></span><pre>        examples = self.matching_raw().filter(frame__frequency__value__gt=0, frame__goodness__gte=3)</pre></div>
<div class="nocov"><span class="num"><pre> 232</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 233</pre></span><pre>            return examples[0].frame</pre></div>
<div class="nocov"><span class="num"><pre> 234</pre></span><pre>        except IndexError:</pre></div>
<div class="nocov"><span class="num"><pre> 235</pre></span><pre>            examples = self.matching_raw().filter(frame__frequency__value__gt=0, frame__goodness__gte=2)</pre></div>
<div class="nocov"><span class="num"><pre> 236</pre></span><pre>            try:</pre></div>
<div class="nocov"><span class="num"><pre> 237</pre></span><pre>                return examples[0].frame</pre></div>
<div class="nocov"><span class="num"><pre> 238</pre></span><pre>            except IndexError:</pre></div>
<div class="skip"><span class="num"><pre> 239</pre></span><pre>                # If we can't find an example, just get the best frame</pre></div>
<div class="nocov"><span class="num"><pre> 240</pre></span><pre>                return Frame.objects.filter(</pre></div>
<div class="nocov"><span class="num"><pre> 241</pre></span><pre>                    language=self.language,</pre></div>
<div class="nocov"><span class="num"><pre> 242</pre></span><pre>                    relation=self.relation,</pre></div>
<div class="nocov"><span class="num"><pre> 243</pre></span><pre>                    frequency__value__gt=0</pre></div>
<div class="nocov"><span class="num"><pre> 244</pre></span><pre>                ).order_by('-goodness')[0]</pre></div>
<div class="skip"><span class="num"><pre> 245</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 246</pre></span><pre>    def nl_statement(self, gap='...'):</pre></div>
<div class="cov"><span class="num"><pre> 247</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 248</pre></span><pre>        Express this feature as a statement in natural language. The omitted</pre></div>
<div class="cov"><span class="num"><pre> 249</pre></span><pre>        concept is replaced by the value in *gap*.</pre></div>
<div class="cov"><span class="num"><pre> 250</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 251</pre></span><pre>        frame, ftext, text1, text2 = self.nl_parts(gap)</pre></div>
<div class="nocov"><span class="num"><pre> 252</pre></span><pre>        return frame.fill_in(text1, text2)</pre></div>
<div class="cov"><span class="num"><pre> 253</pre></span><pre>    def _matching_assertions(self):</pre></div>
<div class="nocov"><span class="num"><pre> 254</pre></span><pre>        return Assertion.objects.filter(</pre></div>
<div class="nocov"><span class="num"><pre> 255</pre></span><pre>          language=self.concept.language,</pre></div>
<div class="nocov"><span class="num"><pre> 256</pre></span><pre>          score__gt=0,</pre></div>
<div class="nocov"><span class="num"><pre> 257</pre></span><pre>          relation=self.relation)</pre></div>
<div class="cov"><span class="num"><pre> 258</pre></span><pre>    def _matching_raw(self):</pre></div>
<div class="nocov"><span class="num"><pre> 259</pre></span><pre>        return RawAssertion.objects.filter(</pre></div>
<div class="nocov"><span class="num"><pre> 260</pre></span><pre>          language=self.concept.language,</pre></div>
<div class="nocov"><span class="num"><pre> 261</pre></span><pre>          assertion__relation=self.relation)</pre></div>
<div class="skip"><span class="num"><pre> 262</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 263</pre></span><pre>    @cached(lambda self, gap: 'nl_parts_'+unicode(self)+'_'+gap, cached.day)</pre></div>
<div class="cov"><span class="num"><pre> 264</pre></span><pre>    def nl_parts(self, gap='...'):</pre></div>
<div class="cov"><span class="num"><pre> 265</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 266</pre></span><pre>        Get a 4-tuple, ``(frame, ftext, text1, text2)``, that contains the</pre></div>
<div class="cov"><span class="num"><pre> 267</pre></span><pre>        information needed to express this feature in natural language:</pre></div>
<div class="skip"><span class="num"><pre> 268</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 269</pre></span><pre>        - The Frame object that is best for expressing this feature.</pre></div>
<div class="cov"><span class="num"><pre> 270</pre></span><pre>        - The text of that frame.</pre></div>
<div class="cov"><span class="num"><pre> 271</pre></span><pre>        - The text that fills the first blank in the frame (which might be</pre></div>
<div class="cov"><span class="num"><pre> 272</pre></span><pre>          :param:`gap`).</pre></div>
<div class="cov"><span class="num"><pre> 273</pre></span><pre>        - The text that fills the second blank in the frame (which might be</pre></div>
<div class="cov"><span class="num"><pre> 274</pre></span><pre>          :param:`gap`).</pre></div>
<div class="cov"><span class="num"><pre> 275</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 276</pre></span><pre>        frame = self.nl_frame()</pre></div>
<div class="nocov"><span class="num"><pre> 277</pre></span><pre>        matching_raw = self.matching_raw()</pre></div>
<div class="nocov"><span class="num"><pre> 278</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 279</pre></span><pre>            surface = matching_raw[0].surface(self.idx)</pre></div>
<div class="nocov"><span class="num"><pre> 280</pre></span><pre>        except IndexError:</pre></div>
<div class="nocov"><span class="num"><pre> 281</pre></span><pre>            surface = self.concept.some_surface() or self.concept</pre></div>
<div class="nocov"><span class="num"><pre> 282</pre></span><pre>        if isinstance(self, LeftFeature):</pre></div>
<div class="nocov"><span class="num"><pre> 283</pre></span><pre>            return (frame, frame.text.replace('{%}', ''), surface.text, gap)</pre></div>
<div class="nocov"><span class="num"><pre> 284</pre></span><pre>        elif isinstance(self, RightFeature):</pre></div>
<div class="nocov"><span class="num"><pre> 285</pre></span><pre>            return (frame, frame.text.replace('{%}', ''), gap, surface.text)</pre></div>
<div class="skip"><span class="num"><pre> 286</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 287</pre></span><pre>    @property</pre></div>
<div class="cov"><span class="num"><pre> 288</pre></span><pre>    def direction(self):</pre></div>
<div class="nocov"><span class="num"><pre> 289</pre></span><pre>        return self.tuple_key</pre></div>
<div class="skip"><span class="num"><pre> 290</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 291</pre></span><pre>    def __repr__(self):</pre></div>
<div class="nocov"><span class="num"><pre> 292</pre></span><pre>        return &quot;&lt;Feature: %s&gt;&quot; % unicode(self)</pre></div>
<div class="skip"><span class="num"><pre> 293</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 294</pre></span><pre>class LeftFeature(Feature):</pre></div>
<div class="cov"><span class="num"><pre> 295</pre></span><pre>    idx = 1</pre></div>
<div class="cov"><span class="num"><pre> 296</pre></span><pre>    tuple_key = 'left'</pre></div>
<div class="cov"><span class="num"><pre> 297</pre></span><pre>    def __unicode__(self):</pre></div>
<div class="nocov"><span class="num"><pre> 298</pre></span><pre>        return '%s\\%s' % (self.concept.text, self.relation)</pre></div>
<div class="cov"><span class="num"><pre> 299</pre></span><pre>    def fill_in(self, newconcept):</pre></div>
<div class="nocov"><span class="num"><pre> 300</pre></span><pre>        return Proposition(self.concept, self.relation, newconcept, self.concept.language)</pre></div>
<div class="cov"><span class="num"><pre> 301</pre></span><pre>    def matching_assertions(self):</pre></div>
<div class="nocov"><span class="num"><pre> 302</pre></span><pre>        return self._matching_assertions().filter(concept1=self.concept)</pre></div>
<div class="cov"><span class="num"><pre> 303</pre></span><pre>    def matching_raw(self):</pre></div>
<div class="nocov"><span class="num"><pre> 304</pre></span><pre>        return self._matching_raw().filter(surface1__concept=self.concept)</pre></div>
<div class="skip"><span class="num"><pre> 305</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 306</pre></span><pre>class RightFeature(Feature):</pre></div>
<div class="cov"><span class="num"><pre> 307</pre></span><pre>    idx = 2</pre></div>
<div class="cov"><span class="num"><pre> 308</pre></span><pre>    tuple_key = 'right'</pre></div>
<div class="cov"><span class="num"><pre> 309</pre></span><pre>    def __unicode__(self):</pre></div>
<div class="nocov"><span class="num"><pre> 310</pre></span><pre>        return '%s/%s' % (self.relation, self.concept.text)</pre></div>
<div class="cov"><span class="num"><pre> 311</pre></span><pre>    def fill_in(self, newconcept):</pre></div>
<div class="nocov"><span class="num"><pre> 312</pre></span><pre>        return Proposition(newconcept, self.relation, self.concept, self.concept.language)</pre></div>
<div class="cov"><span class="num"><pre> 313</pre></span><pre>    def matching_assertions(self):</pre></div>
<div class="nocov"><span class="num"><pre> 314</pre></span><pre>        return self._matching_assertions().filter(concept2=self.concept)</pre></div>
<div class="cov"><span class="num"><pre> 315</pre></span><pre>    def matching_raw(self):</pre></div>
<div class="nocov"><span class="num"><pre> 316</pre></span><pre>        return self._matching_raw().filter(assertion__concept2=self.concept)</pre></div>
<div class="skip"><span class="num"><pre> 317</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 318</pre></span><pre>def ensure_concept(concept):</pre></div>
<div class="nocov"><span class="num"><pre> 319</pre></span><pre>    if isinstance(concept, Concept): return concept</pre></div>
<div class="nocov"><span class="num"><pre> 320</pre></span><pre>    lang = DEFAULT_LANGUAGE</pre></div>
<div class="nocov"><span class="num"><pre> 321</pre></span><pre>    if isinstance(concept, (tuple, list)):</pre></div>
<div class="nocov"><span class="num"><pre> 322</pre></span><pre>        text, lang = concept</pre></div>
<div class="nocov"><span class="num"><pre> 323</pre></span><pre>    else:</pre></div>
<div class="nocov"><span class="num"><pre> 324</pre></span><pre>        text = concept</pre></div>
<div class="nocov"><span class="num"><pre> 325</pre></span><pre>    return Concept.get(text, lang, auto_create=True)</pre></div>
<div class="skip"><span class="num"><pre> 326</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 327</pre></span><pre>class Proposition(object):</pre></div>
<div class="cov"><span class="num"><pre> 328</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 329</pre></span><pre>    A Proposition represents a statement that may or may not be true. It is</pre></div>
<div class="cov"><span class="num"><pre> 330</pre></span><pre>    like an :class:`Assertion` without a truth value.</pre></div>
<div class="cov"><span class="num"><pre> 331</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 332</pre></span><pre>    def __init__(self, concept1, rel, concept2, lang):</pre></div>
<div class="nocov"><span class="num"><pre> 333</pre></span><pre>        self.concept1 = ensure_concept(concept1)</pre></div>
<div class="nocov"><span class="num"><pre> 334</pre></span><pre>        self.relation = rel</pre></div>
<div class="nocov"><span class="num"><pre> 335</pre></span><pre>        self.concept2 = ensure_concept(concept2)</pre></div>
<div class="nocov"><span class="num"><pre> 336</pre></span><pre>        self.lang = lang</pre></div>
<div class="cov"><span class="num"><pre> 337</pre></span><pre>    def __unicode__(self):</pre></div>
<div class="nocov"><span class="num"><pre> 338</pre></span><pre>        return '&lt;Proposition: %s %s %s&gt;' % (self.concept1, self.relation,</pre></div>
<div class="nocov"><span class="num"><pre> 339</pre></span><pre>        self.concept2)</pre></div>
<div class="cov"><span class="num"><pre> 340</pre></span><pre>    def nl_question_bad(self):</pre></div>
<div class="cov"><span class="num"><pre> 341</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 342</pre></span><pre>        Express this Proposition as a question in natural language, poorly.</pre></div>
<div class="cov"><span class="num"><pre> 343</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 344</pre></span><pre>        frame = Frame.objects.filter(language=self.lang, relation=self.relation,</pre></div>
<div class="nocov"><span class="num"><pre> 345</pre></span><pre>                                     goodness__gte=3)[0]</pre></div>
<div class="nocov"><span class="num"><pre> 346</pre></span><pre>        same_c1 = RawAssertion.objects.filter(language=self.lang,</pre></div>
<div class="nocov"><span class="num"><pre> 347</pre></span><pre>            frame__relation=self.relation, surface1__concept=self.concept1)</pre></div>
<div class="nocov"><span class="num"><pre> 348</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 349</pre></span><pre>            surface1 = same_c1[0].surface1.text</pre></div>
<div class="nocov"><span class="num"><pre> 350</pre></span><pre>        except IndexError:</pre></div>
<div class="nocov"><span class="num"><pre> 351</pre></span><pre>            surface1 = self.concept1.some_surface() or self.concept1</pre></div>
<div class="nocov"><span class="num"><pre> 352</pre></span><pre>            surface1 = surface1.text</pre></div>
<div class="nocov"><span class="num"><pre> 353</pre></span><pre>        same_c2 = RawAssertion.objects.filter(language=self.lang,</pre></div>
<div class="nocov"><span class="num"><pre> 354</pre></span><pre>            frame__relation=self.relation, surface2__concept=self.concept2)</pre></div>
<div class="nocov"><span class="num"><pre> 355</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 356</pre></span><pre>            surface2 = same_c2[0].surface2.text</pre></div>
<div class="nocov"><span class="num"><pre> 357</pre></span><pre>        except IndexError:</pre></div>
<div class="nocov"><span class="num"><pre> 358</pre></span><pre>            surface2 = self.concept2.some_surface() or self.concept2</pre></div>
<div class="nocov"><span class="num"><pre> 359</pre></span><pre>            surface2 = surface2.text</pre></div>
<div class="skip"><span class="num"><pre> 360</pre></span><pre>        # The wiki-like brackets should be replaced by appropriate formatting.</pre></div>
<div class="nocov"><span class="num"><pre> 361</pre></span><pre>        surface1b = &quot;[[%s]]&quot; % surface1</pre></div>
<div class="nocov"><span class="num"><pre> 362</pre></span><pre>        surface2b = &quot;[[%s]]&quot; % surface2</pre></div>
<div class="skip"><span class="num"><pre> 363</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 364</pre></span><pre>        if frame.question_yn:</pre></div>
<div class="nocov"><span class="num"><pre> 365</pre></span><pre>            return frame.question_yn.replace('{1}', surface1b)\</pre></div>
<div class="nocov"><span class="num"><pre> 366</pre></span><pre>                   .replace('{2}', surface2b)</pre></div>
<div class="nocov"><span class="num"><pre> 367</pre></span><pre>        else:</pre></div>
<div class="nocov"><span class="num"><pre> 368</pre></span><pre>            return frame.text.replace('{1}', surface1b)\</pre></div>
<div class="nocov"><span class="num"><pre> 369</pre></span><pre>                   .replace('{2}', surface2b)\</pre></div>
<div class="nocov"><span class="num"><pre> 370</pre></span><pre>                   .replace('{%}', '') + '?'</pre></div>
<div class="cov"><span class="num"><pre> 371</pre></span><pre>    def right_feature(self):</pre></div>
<div class="nocov"><span class="num"><pre> 372</pre></span><pre>        return RightFeature(self.relation, self.concept2)</pre></div>
<div class="cov"><span class="num"><pre> 373</pre></span><pre>    def left_feature(self):</pre></div>
<div class="nocov"><span class="num"><pre> 374</pre></span><pre>        return LeftFeature(self.relation, self.concept1)</pre></div>
<div class="cov"><span class="num"><pre> 375</pre></span><pre>    def nl_parts(self):</pre></div>
<div class="cov"><span class="num"><pre> 376</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 377</pre></span><pre>        Get a 4-tuple, ``(frame, ftext, text1, text2)``, that contains the</pre></div>
<div class="cov"><span class="num"><pre> 378</pre></span><pre>        information needed to express this feature in natural language:</pre></div>
<div class="skip"><span class="num"><pre> 379</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 380</pre></span><pre>        - The Frame object that is best for expressing this feature.</pre></div>
<div class="cov"><span class="num"><pre> 381</pre></span><pre>        - The text of that frame.</pre></div>
<div class="cov"><span class="num"><pre> 382</pre></span><pre>        - The text that fills the first blank in the frame.</pre></div>
<div class="cov"><span class="num"><pre> 383</pre></span><pre>        - The text that fills the second blank in the frame.</pre></div>
<div class="cov"><span class="num"><pre> 384</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre> 385</pre></span><pre>        # TODO: replace this with something cleverer but still sufficiently</pre></div>
<div class="skip"><span class="num"><pre> 386</pre></span><pre>        # fast</pre></div>
<div class="nocov"><span class="num"><pre> 387</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 388</pre></span><pre>            frame = Frame.objects.filter(language=self.lang,</pre></div>
<div class="nocov"><span class="num"><pre> 389</pre></span><pre>            relation=self.relation, goodness__gte=3)[0]</pre></div>
<div class="nocov"><span class="num"><pre> 390</pre></span><pre>        except IndexError:</pre></div>
<div class="nocov"><span class="num"><pre> 391</pre></span><pre>            frame = Frame.objects.filter(language=self.lang,</pre></div>
<div class="nocov"><span class="num"><pre> 392</pre></span><pre>            relation=self.relation).order_by('-goodness')[0]</pre></div>
<div class="skip"><span class="num"><pre> 393</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 394</pre></span><pre>        #frame = self.right_feature().nl_frame()</pre></div>
<div class="skip"><span class="num"><pre> 395</pre></span><pre>        #surfaces = {}</pre></div>
<div class="nocov"><span class="num"><pre> 396</pre></span><pre>        same_c1 = RawAssertion.objects.filter(frame__relation=self.relation,</pre></div>
<div class="nocov"><span class="num"><pre> 397</pre></span><pre>                                              surface1__concept=self.concept1)</pre></div>
<div class="nocov"><span class="num"><pre> 398</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 399</pre></span><pre>            surface1 = same_c1[0].surface1.text</pre></div>
<div class="nocov"><span class="num"><pre> 400</pre></span><pre>        except IndexError:</pre></div>
<div class="nocov"><span class="num"><pre> 401</pre></span><pre>            surface1 = self.concept1.some_surface() or self.concept1</pre></div>
<div class="nocov"><span class="num"><pre> 402</pre></span><pre>            surface1 = surface1.text</pre></div>
<div class="nocov"><span class="num"><pre> 403</pre></span><pre>        same_c2 = RawAssertion.objects.filter(language=self.lang,</pre></div>
<div class="nocov"><span class="num"><pre> 404</pre></span><pre>            frame__relation=self.relation, surface2__concept=self.concept2)            </pre></div>
<div class="nocov"><span class="num"><pre> 405</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 406</pre></span><pre>            surface2 = same_c2[0].surface2.text</pre></div>
<div class="nocov"><span class="num"><pre> 407</pre></span><pre>        except IndexError:</pre></div>
<div class="nocov"><span class="num"><pre> 408</pre></span><pre>            surface2 = self.concept2.some_surface() or self.concept2</pre></div>
<div class="nocov"><span class="num"><pre> 409</pre></span><pre>            surface2 = surface2.text</pre></div>
<div class="nocov"><span class="num"><pre> 410</pre></span><pre>        return (frame, frame.text, surface1, surface2)</pre></div>
<div class="skip"><span class="num"><pre> 411</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 412</pre></span><pre>    def nl_parts_topdown(self):</pre></div>
<div class="nocov"><span class="num"><pre> 413</pre></span><pre>        frame = Frame.objects.filter(language=self.lang,</pre></div>
<div class="nocov"><span class="num"><pre> 414</pre></span><pre>        relation=self.relation, goodness__gte=3)[0]</pre></div>
<div class="skip"><span class="num"><pre> 415</pre></span><pre>        #surfaces = {}</pre></div>
<div class="nocov"><span class="num"><pre> 416</pre></span><pre>        same_c1 = RawAssertion.objects.filter(language=self.lang,</pre></div>
<div class="nocov"><span class="num"><pre> 417</pre></span><pre>            frame__relation=self.relation, surface1__concept=self.concept1)</pre></div>
<div class="nocov"><span class="num"><pre> 418</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 419</pre></span><pre>            surface1 = same_c1[0].surface1.text</pre></div>
<div class="nocov"><span class="num"><pre> 420</pre></span><pre>        except IndexError:</pre></div>
<div class="nocov"><span class="num"><pre> 421</pre></span><pre>            surface1 = self.concept1.some_surface() or self.concept1</pre></div>
<div class="nocov"><span class="num"><pre> 422</pre></span><pre>            surface1 = surface1.text</pre></div>
<div class="nocov"><span class="num"><pre> 423</pre></span><pre>        same_c2 = RawAssertion.objects.filter(language=self.lang,</pre></div>
<div class="nocov"><span class="num"><pre> 424</pre></span><pre>            frame__relation=self.relation, surface2__concept=self.concept2)            </pre></div>
<div class="nocov"><span class="num"><pre> 425</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 426</pre></span><pre>            surface2 = same_c2[0].surface2.text</pre></div>
<div class="nocov"><span class="num"><pre> 427</pre></span><pre>        except IndexError:</pre></div>
<div class="nocov"><span class="num"><pre> 428</pre></span><pre>            surface2 = self.concept2.some_surface() or self.concept2</pre></div>
<div class="nocov"><span class="num"><pre> 429</pre></span><pre>            surface2 = surface2.text</pre></div>
<div class="nocov"><span class="num"><pre> 430</pre></span><pre>        return (frame, frame.text, surface1, surface2)</pre></div>
<div class="skip"><span class="num"><pre> 431</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 432</pre></span><pre>class Concept(models.Model):</pre></div>
<div class="cov"><span class="num"><pre> 433</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 434</pre></span><pre>    Concepts are the nodes of ConceptNet. They are the things that people have</pre></div>
<div class="cov"><span class="num"><pre> 435</pre></span><pre>    common sense knowledge about.</pre></div>
<div class="skip"><span class="num"><pre> 436</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 437</pre></span><pre>    Concepts are expressed in natural language with</pre></div>
<div class="cov"><span class="num"><pre> 438</pre></span><pre>    sets of related words and phrases: for example, &quot;take a picture&quot;, &quot;taking</pre></div>
<div class="cov"><span class="num"><pre> 439</pre></span><pre>    pictures&quot;, &quot;to take pictures&quot;, and &quot;you take a picture&quot; are various</pre></div>
<div class="cov"><span class="num"><pre> 440</pre></span><pre>    `surface forms`_ of the same Concept.</pre></div>
<div class="cov"><span class="num"><pre> 441</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 442</pre></span><pre>    language = models.ForeignKey(Language)</pre></div>
<div class="cov"><span class="num"><pre> 443</pre></span><pre>    text = models.TextField(db_index=True)</pre></div>
<div class="cov"><span class="num"><pre> 444</pre></span><pre>    num_assertions = models.IntegerField(default=0)</pre></div>
<div class="skip"><span class="num"><pre> 445</pre></span><pre>    # canonical_name = models.TextField()</pre></div>
<div class="cov"><span class="num"><pre> 446</pre></span><pre>    words = models.IntegerField()</pre></div>
<div class="cov"><span class="num"><pre> 447</pre></span><pre>    visible = models.BooleanField(default=False)</pre></div>
<div class="skip"><span class="num"><pre> 448</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 449</pre></span><pre>    def save(self, *a, **kw):</pre></div>
<div class="cov"><span class="num"><pre> 450</pre></span><pre>        ''' Ensures that a concept has a correct word count.  Called</pre></div>
<div class="cov"><span class="num"><pre> 451</pre></span><pre>        before saving a concept.</pre></div>
<div class="cov"><span class="num"><pre> 452</pre></span><pre>        '''</pre></div>
<div class="nocov"><span class="num"><pre> 453</pre></span><pre>        self.words = len(self.text.split())</pre></div>
<div class="nocov"><span class="num"><pre> 454</pre></span><pre>        super(Concept, self).save(*a, **kw)</pre></div>
<div class="skip"><span class="num"><pre> 455</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 456</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 457</pre></span><pre>    @property</pre></div>
<div class="cov"><span class="num"><pre> 458</pre></span><pre>    @cached(lambda self: 'concept_canonical_name_'+self.text, cached.week)</pre></div>
<div class="cov"><span class="num"><pre> 459</pre></span><pre>    def canonical_name(self):</pre></div>
<div class="nocov"><span class="num"><pre> 460</pre></span><pre>        return self.some_surface().text</pre></div>
<div class="skip"><span class="num"><pre> 461</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 462</pre></span><pre>    def __unicode__(self):</pre></div>
<div class="nocov"><span class="num"><pre> 463</pre></span><pre>        return u&quot;&lt;&quot; + self.language.id + &quot;: &quot; + self.text + &quot;&gt;&quot;</pre></div>
<div class="skip"><span class="num"><pre> 464</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 465</pre></span><pre>    def get_assertions(self, useful_only=True):</pre></div>
<div class="cov"><span class="num"><pre> 466</pre></span><pre>        '''Get all :class:`Assertions` about this concept.'''</pre></div>
<div class="nocov"><span class="num"><pre> 467</pre></span><pre>        return Assertion.get_filtered(Q(concept1=self) | Q(concept2=self), useful_only=useful_only)</pre></div>
<div class="skip"><span class="num"><pre> 468</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 469</pre></span><pre>    def get_assertions_forward(self, useful_only=True):</pre></div>
<div class="cov"><span class="num"><pre> 470</pre></span><pre>        '''Get all :class:`Assertions` with this concept on the left.'''</pre></div>
<div class="nocov"><span class="num"><pre> 471</pre></span><pre>        return Assertion.get_filtered(Q(concept1=self), useful_only=useful_only)</pre></div>
<div class="skip"><span class="num"><pre> 472</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 473</pre></span><pre>    def get_assertions_reverse(self, useful_only=True):</pre></div>
<div class="cov"><span class="num"><pre> 474</pre></span><pre>        '''Get all :class:`Assertions` with this concept on the right.'''</pre></div>
<div class="nocov"><span class="num"><pre> 475</pre></span><pre>        return Assertion.get_filtered(Q(concept2=self), useful_only=useful_only)</pre></div>
<div class="skip"><span class="num"><pre> 476</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 477</pre></span><pre>    def raw_assertions(self):</pre></div>
<div class="nocov"><span class="num"><pre> 478</pre></span><pre>        got = RawAssertion.objects.filter(</pre></div>
<div class="nocov"><span class="num"><pre> 479</pre></span><pre>            (Q(assertion__concept1=self) | Q(assertion__concept2=self))</pre></div>
<div class="nocov"><span class="num"><pre> 480</pre></span><pre>            &amp; Q(score__gt=0) &amp; Q(assertion__score__gt=0)</pre></div>
<div class="nocov"><span class="num"><pre> 481</pre></span><pre>        )</pre></div>
<div class="nocov"><span class="num"><pre> 482</pre></span><pre>        return got</pre></div>
<div class="skip"><span class="num"><pre> 483</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 484</pre></span><pre>    def raw_assertions_no_dupes(self, n=10, related=None):</pre></div>
<div class="nocov"><span class="num"><pre> 485</pre></span><pre>        from django.db.models import F</pre></div>
<div class="nocov"><span class="num"><pre> 486</pre></span><pre>        got = RawAssertion.objects.filter(</pre></div>
<div class="nocov"><span class="num"><pre> 487</pre></span><pre>            (Q(assertion__concept1=self) | Q(assertion__concept2=self))</pre></div>
<div class="nocov"><span class="num"><pre> 488</pre></span><pre>            &amp; Q(score__gt=0) &amp; Q(assertion__score__gt=0)</pre></div>
<div class="nocov"><span class="num"><pre> 489</pre></span><pre>            &amp; Q(assertion__best_raw_id=F('id'))</pre></div>
<div class="nocov"><span class="num"><pre> 490</pre></span><pre>        )</pre></div>
<div class="skip"><span class="num"><pre> 491</pre></span><pre>        #all_raw = RawAssertion.objects.filter(</pre></div>
<div class="skip"><span class="num"><pre> 492</pre></span><pre>        #    (Q(assertion__concept1=self) | Q(assertion__concept2=self))</pre></div>
<div class="skip"><span class="num"><pre> 493</pre></span><pre>        #    &amp; Q(score__gt=0) &amp; Q(assertion__score__gt=0)</pre></div>
<div class="skip"><span class="num"><pre> 494</pre></span><pre>        #)</pre></div>
<div class="skip"><span class="num"><pre> 495</pre></span><pre>        #if related: all_raw = all_raw.select_related(**related)</pre></div>
<div class="skip"><span class="num"><pre> 496</pre></span><pre>        #used = set()</pre></div>
<div class="skip"><span class="num"><pre> 497</pre></span><pre>        #got = []</pre></div>
<div class="skip"><span class="num"><pre> 498</pre></span><pre>        #for raw in all_raw:</pre></div>
<div class="skip"><span class="num"><pre> 499</pre></span><pre>        #    if raw.assertion in used: continue</pre></div>
<div class="skip"><span class="num"><pre> 500</pre></span><pre>        #    used.add(raw.assertion)</pre></div>
<div class="skip"><span class="num"><pre> 501</pre></span><pre>        #    got.append(raw)</pre></div>
<div class="skip"><span class="num"><pre> 502</pre></span><pre>        #    if len(got) &gt;= n: break</pre></div>
<div class="nocov"><span class="num"><pre> 503</pre></span><pre>        return got</pre></div>
<div class="skip"><span class="num"><pre> 504</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 505</pre></span><pre>    def get_my_right_features(self, useful_only=True):</pre></div>
<div class="cov"><span class="num"><pre> 506</pre></span><pre>        '''</pre></div>
<div class="cov"><span class="num"><pre> 507</pre></span><pre>        Get all the RightFeatures that have been asserted about this concept.</pre></div>
<div class="skip"><span class="num"><pre> 508</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 509</pre></span><pre>        Returns a list of (feature, frequency, score, assertion) tuples.</pre></div>
<div class="cov"><span class="num"><pre> 510</pre></span><pre>        '''</pre></div>
<div class="nocov"><span class="num"><pre> 511</pre></span><pre>        return [(RightFeature(a.relation, a.concept2), a.frequency, a.score, a)</pre></div>
<div class="nocov"><span class="num"><pre> 512</pre></span><pre>                for a in self.get_assertions_forward(useful_only)]</pre></div>
<div class="skip"><span class="num"><pre> 513</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 514</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 515</pre></span><pre>    def get_my_left_features(self, useful_only=True):</pre></div>
<div class="cov"><span class="num"><pre> 516</pre></span><pre>        '''</pre></div>
<div class="cov"><span class="num"><pre> 517</pre></span><pre>        Get all the LeftFeatures that have been asserted about this concept.</pre></div>
<div class="skip"><span class="num"><pre> 518</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 519</pre></span><pre>        Returns a list of (feature, frequency, score, assertion) tuples.</pre></div>
<div class="cov"><span class="num"><pre> 520</pre></span><pre>        '''</pre></div>
<div class="nocov"><span class="num"><pre> 521</pre></span><pre>        return [(LeftFeature(a.relation, a.concept1), a.frequency, a.score, a)</pre></div>
<div class="nocov"><span class="num"><pre> 522</pre></span><pre>                for a in self.get_assertions_reverse(useful_only)]</pre></div>
<div class="skip"><span class="num"><pre> 523</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 524</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 525</pre></span><pre>    def has_feature(self, feature):</pre></div>
<div class="cov"><span class="num"><pre> 526</pre></span><pre>        '''</pre></div>
<div class="cov"><span class="num"><pre> 527</pre></span><pre>        Returns True if the concept has the given feature.</pre></div>
<div class="cov"><span class="num"><pre> 528</pre></span><pre>        '''</pre></div>
<div class="nocov"><span class="num"><pre> 529</pre></span><pre>        score = self.score_for_feature(feature)</pre></div>
<div class="nocov"><span class="num"><pre> 530</pre></span><pre>        return score is not None and score &gt; 0</pre></div>
<div class="skip"><span class="num"><pre> 531</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 532</pre></span><pre>    def score_for_feature(self, feature):</pre></div>
<div class="nocov"><span class="num"><pre> 533</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 534</pre></span><pre>            assertions = Assertion.objects.filter(relation=feature.relation)</pre></div>
<div class="nocov"><span class="num"><pre> 535</pre></span><pre>            if feature.tuple_key == 'left':</pre></div>
<div class="nocov"><span class="num"><pre> 536</pre></span><pre>                assertions = assertions.filter(concept1=feature.concept,</pre></div>
<div class="nocov"><span class="num"><pre> 537</pre></span><pre>                                               concept2=self)</pre></div>
<div class="nocov"><span class="num"><pre> 538</pre></span><pre>            else:</pre></div>
<div class="nocov"><span class="num"><pre> 539</pre></span><pre>                assertions = assertions.filter(concept1=self,</pre></div>
<div class="nocov"><span class="num"><pre> 540</pre></span><pre>                                               concept2=feature.concept)</pre></div>
<div class="nocov"><span class="num"><pre> 541</pre></span><pre>            return max(a.score for a in assertions)</pre></div>
<div class="nocov"><span class="num"><pre> 542</pre></span><pre>        except ValueError: # what max() throws for an empty sequence</pre></div>
<div class="nocov"><span class="num"><pre> 543</pre></span><pre>            return None</pre></div>
<div class="skip"><span class="num"><pre> 544</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 545</pre></span><pre>    def group_assertions_by_feature(self, useful_only=True):</pre></div>
<div class="nocov"><span class="num"><pre> 546</pre></span><pre>        forward_assertions = self.get_assertions_forward(useful_only)\</pre></div>
<div class="nocov"><span class="num"><pre> 547</pre></span><pre>          .select_related('all_raw__surface2', 'frequency')</pre></div>
<div class="nocov"><span class="num"><pre> 548</pre></span><pre>        reverse_assertions = self.get_assertions_reverse(useful_only)\</pre></div>
<div class="nocov"><span class="num"><pre> 549</pre></span><pre>          .select_related('all_raw__surface1', 'frequency')</pre></div>
<div class="nocov"><span class="num"><pre> 550</pre></span><pre>        thedict = {}</pre></div>
<div class="nocov"><span class="num"><pre> 551</pre></span><pre>        for a in forward_assertions:</pre></div>
<div class="skip"><span class="num"><pre> 552</pre></span><pre>            # FIXME: seems that features no longer have polarity.</pre></div>
<div class="nocov"><span class="num"><pre> 553</pre></span><pre>            thedict.setdefault(LeftFeature(a.relation, self, a.polarity), [])\</pre></div>
<div class="nocov"><span class="num"><pre> 554</pre></span><pre>                .append((a.best_raw().surface2.text, a))</pre></div>
<div class="nocov"><span class="num"><pre> 555</pre></span><pre>        for a in reverse_assertions:</pre></div>
<div class="nocov"><span class="num"><pre> 556</pre></span><pre>            thedict.setdefault(RightFeature(a.relation, self, a.polarity), [])\</pre></div>
<div class="nocov"><span class="num"><pre> 557</pre></span><pre>                .append((a.best_raw().surface1.text, a))</pre></div>
<div class="nocov"><span class="num"><pre> 558</pre></span><pre>        return thedict</pre></div>
<div class="skip"><span class="num"><pre> 559</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 560</pre></span><pre>    def top_assertions_by_feature(self, limit=50, useful_only=True):</pre></div>
<div class="nocov"><span class="num"><pre> 561</pre></span><pre>        results = []</pre></div>
<div class="nocov"><span class="num"><pre> 562</pre></span><pre>        manager = Assertion.objects</pre></div>
<div class="skip"><span class="num"><pre> 563</pre></span><pre>        # forward relations</pre></div>
<div class="nocov"><span class="num"><pre> 564</pre></span><pre>        for relation in Relation.objects.all():</pre></div>
<div class="nocov"><span class="num"><pre> 565</pre></span><pre>            feature = LeftFeature(relation, self)</pre></div>
<div class="nocov"><span class="num"><pre> 566</pre></span><pre>            filtered = manager.filter(concept1=self, relation=relation,</pre></div>
<div class="nocov"><span class="num"><pre> 567</pre></span><pre>                                      best_surface2__isnull=False)</pre></div>
<div class="nocov"><span class="num"><pre> 568</pre></span><pre>            if useful_only:</pre></div>
<div class="nocov"><span class="num"><pre> 569</pre></span><pre>                filtered = filtered.filter(score__gt=0)</pre></div>
<div class="nocov"><span class="num"><pre> 570</pre></span><pre>            expanded = filtered.select_related(</pre></div>
<div class="nocov"><span class="num"><pre> 571</pre></span><pre>                'frequency', 'best_surface2'</pre></div>
<div class="nocov"><span class="num"><pre> 572</pre></span><pre>            )</pre></div>
<div class="nocov"><span class="num"><pre> 573</pre></span><pre>            best = expanded[:limit]</pre></div>
<div class="skip"><span class="num"><pre> 574</pre></span><pre>            </pre></div>
<div class="nocov"><span class="num"><pre> 575</pre></span><pre>            described = [(a.best_surface2.text, a.frequency.text,</pre></div>
<div class="nocov"><span class="num"><pre> 576</pre></span><pre>                          a.frequency.value &gt; 0, a) for a in best]</pre></div>
<div class="nocov"><span class="num"><pre> 577</pre></span><pre>            if len(described) &gt; 0: results.append((feature, described))</pre></div>
<div class="skip"><span class="num"><pre> 578</pre></span><pre>        # backward relations</pre></div>
<div class="nocov"><span class="num"><pre> 579</pre></span><pre>        for relation in Relation.objects.all():</pre></div>
<div class="nocov"><span class="num"><pre> 580</pre></span><pre>            feature = RightFeature(relation, self)</pre></div>
<div class="nocov"><span class="num"><pre> 581</pre></span><pre>            filtered = manager.filter(concept2=self, relation=relation,</pre></div>
<div class="nocov"><span class="num"><pre> 582</pre></span><pre>                                      best_surface1__isnull=False)</pre></div>
<div class="nocov"><span class="num"><pre> 583</pre></span><pre>            if useful_only:</pre></div>
<div class="nocov"><span class="num"><pre> 584</pre></span><pre>                filtered = filtered.filter(score__gt=0)</pre></div>
<div class="nocov"><span class="num"><pre> 585</pre></span><pre>            expanded = filtered.select_related(</pre></div>
<div class="nocov"><span class="num"><pre> 586</pre></span><pre>                'frequency', 'best_surface1'</pre></div>
<div class="nocov"><span class="num"><pre> 587</pre></span><pre>            )</pre></div>
<div class="nocov"><span class="num"><pre> 588</pre></span><pre>            best = expanded[:limit]</pre></div>
<div class="skip"><span class="num"><pre> 589</pre></span><pre>            </pre></div>
<div class="nocov"><span class="num"><pre> 590</pre></span><pre>            described = [(a.best_surface1.text, a.frequency.text,</pre></div>
<div class="nocov"><span class="num"><pre> 591</pre></span><pre>                          a.frequency.value &gt; 0, a) for a in best]</pre></div>
<div class="nocov"><span class="num"><pre> 592</pre></span><pre>            if len(described) &gt; 0: results.append((feature, described))</pre></div>
<div class="nocov"><span class="num"><pre> 593</pre></span><pre>        results.sort(key=lambda x: -len(x[1]))</pre></div>
<div class="nocov"><span class="num"><pre> 594</pre></span><pre>        return results</pre></div>
<div class="skip"><span class="num"><pre> 595</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 596</pre></span><pre>    def some_surface(self):</pre></div>
<div class="cov"><span class="num"><pre> 597</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 598</pre></span><pre>        Get an arbitrary :class:`SurfaceForm` representing this concept.</pre></div>
<div class="skip"><span class="num"><pre> 599</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 600</pre></span><pre>        Returns None if the concept has no surface form.</pre></div>
<div class="cov"><span class="num"><pre> 601</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 602</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 603</pre></span><pre>            return self.surfaceform_set.all()[0]</pre></div>
<div class="nocov"><span class="num"><pre> 604</pre></span><pre>        except IndexError:</pre></div>
<div class="nocov"><span class="num"><pre> 605</pre></span><pre>            return None</pre></div>
<div class="skip"><span class="num"><pre> 606</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 607</pre></span><pre>    @classmethod</pre></div>
<div class="cov"><span class="num"><pre> 608</pre></span><pre>    def get(cls, text, language, auto_create=False):</pre></div>
<div class="cov"><span class="num"><pre> 609</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 610</pre></span><pre>        Get the Concept represented by a given string of text.</pre></div>
<div class="skip"><span class="num"><pre> 611</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 612</pre></span><pre>        If the Concept does not exist, this method will return None by default.</pre></div>
<div class="cov"><span class="num"><pre> 613</pre></span><pre>        However, if the parameter ``auto_create=True`` is given, then this will</pre></div>
<div class="cov"><span class="num"><pre> 614</pre></span><pre>        create the Concept (adding it to the database) instead.</pre></div>
<div class="skip"><span class="num"><pre> 615</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 616</pre></span><pre>        You should not run the string through a normalizer, or use a string</pre></div>
<div class="cov"><span class="num"><pre> 617</pre></span><pre>        which came from :attr:`Concept.text` (which is equivalent). If you</pre></div>
<div class="cov"><span class="num"><pre> 618</pre></span><pre>        have a normalized string, you should use :meth:`get_raw` instead.</pre></div>
<div class="cov"><span class="num"><pre> 619</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 620</pre></span><pre>        if not isinstance(language, Language):</pre></div>
<div class="cov"><span class="num"><pre> 621</pre></span><pre>            language = Language.get(language)</pre></div>
<div class="cov"><span class="num"><pre> 622</pre></span><pre>        surface = SurfaceForm.get(text, language, auto_create)</pre></div>
<div class="cov"><span class="num"><pre> 623</pre></span><pre>        if surface is None:</pre></div>
<div class="nocov"><span class="num"><pre> 624</pre></span><pre>            return Concept.get_raw(language.nl.normalize4(text), language)</pre></div>
<div class="cov"><span class="num"><pre> 625</pre></span><pre>        return surface.concept</pre></div>
<div class="skip"><span class="num"><pre> 626</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 627</pre></span><pre>    @classmethod</pre></div>
<div class="cov"><span class="num"><pre> 628</pre></span><pre>    def get_raw(cls, normalized_text, language, auto_create=False):</pre></div>
<div class="cov"><span class="num"><pre> 629</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 630</pre></span><pre>        Get the Concept whose normalized form is the given string.</pre></div>
<div class="skip"><span class="num"><pre> 631</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 632</pre></span><pre>        If the Concept does not exist, this method will raise a</pre></div>
<div class="cov"><span class="num"><pre> 633</pre></span><pre>        Concept.DoesNotExist exception.  However, if the parameter</pre></div>
<div class="cov"><span class="num"><pre> 634</pre></span><pre>        ``auto_create=True`` is given, then this will create the</pre></div>
<div class="cov"><span class="num"><pre> 635</pre></span><pre>        Concept (adding it to the database) instead.</pre></div>
<div class="skip"><span class="num"><pre> 636</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 637</pre></span><pre>        Normalized forms should not be assumed to be stable; they may change</pre></div>
<div class="cov"><span class="num"><pre> 638</pre></span><pre>        between releases.</pre></div>
<div class="cov"><span class="num"><pre> 639</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 640</pre></span><pre>        if auto_create:</pre></div>
<div class="nocov"><span class="num"><pre> 641</pre></span><pre>            concept_obj, created = cls.objects.get_or_create(text=normalized_text,language=language)</pre></div>
<div class="cov"><span class="num"><pre> 642</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre> 643</pre></span><pre>            concept_obj = cls.objects.get(text=normalized_text,language=language)</pre></div>
<div class="cov"><span class="num"><pre> 644</pre></span><pre>        return concept_obj</pre></div>
<div class="skip"><span class="num"><pre> 645</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 646</pre></span><pre>    @classmethod</pre></div>
<div class="cov"><span class="num"><pre> 647</pre></span><pre>    def exists(cls, text, language, is_raw=False):</pre></div>
<div class="cov"><span class="num"><pre> 648</pre></span><pre>        '''</pre></div>
<div class="cov"><span class="num"><pre> 649</pre></span><pre>        Determine if a concept exists in ConceptNet.</pre></div>
<div class="skip"><span class="num"><pre> 650</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 651</pre></span><pre>        If `is_raw` is True, `text` is considered to be already in the</pre></div>
<div class="cov"><span class="num"><pre> 652</pre></span><pre>        raw (normalized) concept form. Otherwise, it is normalized</pre></div>
<div class="cov"><span class="num"><pre> 653</pre></span><pre>        before being checked in the database.</pre></div>
<div class="cov"><span class="num"><pre> 654</pre></span><pre>        '''</pre></div>
<div class="nocov"><span class="num"><pre> 655</pre></span><pre>        if not isinstance(language, Language):</pre></div>
<div class="nocov"><span class="num"><pre> 656</pre></span><pre>            language = Language.get(language)</pre></div>
<div class="nocov"><span class="num"><pre> 657</pre></span><pre>        if not is_raw:</pre></div>
<div class="nocov"><span class="num"><pre> 658</pre></span><pre>            surface = SurfaceForm.get(text, language, False)</pre></div>
<div class="nocov"><span class="num"><pre> 659</pre></span><pre>            if surface is not None: return True</pre></div>
<div class="nocov"><span class="num"><pre> 660</pre></span><pre>            text = language.nl.normalize4(text)</pre></div>
<div class="skip"><span class="num"><pre> 661</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 662</pre></span><pre>        return cls.exists_raw(text, language)</pre></div>
<div class="skip"><span class="num"><pre> 663</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 664</pre></span><pre>    @classmethod</pre></div>
<div class="cov"><span class="num"><pre> 665</pre></span><pre>    def exists_raw(cls, normalized_text, language):</pre></div>
<div class="nocov"><span class="num"><pre> 666</pre></span><pre>        return bool(cls.objects.filter(text=normalized_text, language=language))</pre></div>
<div class="skip"><span class="num"><pre> 667</pre></span><pre>            </pre></div>
<div class="skip"><span class="num"><pre> 668</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 669</pre></span><pre>    @classmethod</pre></div>
<div class="cov"><span class="num"><pre> 670</pre></span><pre>    @cached(lambda cls, id: 'conceptbyid_%d' % id, cached.minute)</pre></div>
<div class="cov"><span class="num"><pre> 671</pre></span><pre>    def get_by_id(cls, id):</pre></div>
<div class="nocov"><span class="num"><pre> 672</pre></span><pre>        return cls.objects.get(id=id)</pre></div>
<div class="skip"><span class="num"><pre> 673</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 674</pre></span><pre>    # used in commons</pre></div>
<div class="cov"><span class="num"><pre> 675</pre></span><pre>    def get_absolute_url(self):</pre></div>
<div class="nocov"><span class="num"><pre> 676</pre></span><pre>        return '/%s/concept/+%s/' % (self.language.id, urlquote(self.text))</pre></div>
<div class="skip"><span class="num"><pre> 677</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 678</pre></span><pre>    def get_containing_threads(self):</pre></div>
<div class="nocov"><span class="num"><pre> 679</pre></span><pre>        from csc.threads.models import SimpleThread</pre></div>
<div class="nocov"><span class="num"><pre> 680</pre></span><pre>        return SimpleThread.containing_concept(self).filter(rev=3)</pre></div>
<div class="skip"><span class="num"><pre> 681</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 682</pre></span><pre>    def get_terminating_threads(self):</pre></div>
<div class="nocov"><span class="num"><pre> 683</pre></span><pre>        from csc.threads.models import SimpleThread</pre></div>
<div class="nocov"><span class="num"><pre> 684</pre></span><pre>        return SimpleThread.objects.filter(rev=3, concept=self)</pre></div>
<div class="skip"><span class="num"><pre> 685</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 686</pre></span><pre>    def get_tree(self, objects=True):</pre></div>
<div class="cov"><span class="num"><pre> 687</pre></span><pre>        '''Collect all the edges of threads that contains this concept.'''</pre></div>
<div class="nocov"><span class="num"><pre> 688</pre></span><pre>        edges = set()</pre></div>
<div class="skip"><span class="num"><pre> 689</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 690</pre></span><pre>        for thread in self.get_containing_threads():</pre></div>
<div class="nocov"><span class="num"><pre> 691</pre></span><pre>            thread = thread.full_thread()</pre></div>
<div class="nocov"><span class="num"><pre> 692</pre></span><pre>            for idx in xrange(len(thread)-1):</pre></div>
<div class="nocov"><span class="num"><pre> 693</pre></span><pre>                edges.add((thread[idx], thread[idx+1]))</pre></div>
<div class="skip"><span class="num"><pre> 694</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 695</pre></span><pre>        if not objects:</pre></div>
<div class="nocov"><span class="num"><pre> 696</pre></span><pre>            return edges</pre></div>
<div class="skip"><span class="num"><pre> 697</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 698</pre></span><pre>        def edges_as_concept_objects(edges):</pre></div>
<div class="nocov"><span class="num"><pre> 699</pre></span><pre>            known_concepts = {self.id: self}</pre></div>
<div class="nocov"><span class="num"><pre> 700</pre></span><pre>            def get_concept(cid):</pre></div>
<div class="nocov"><span class="num"><pre> 701</pre></span><pre>                if cid not in known_concepts:</pre></div>
<div class="nocov"><span class="num"><pre> 702</pre></span><pre>                    known_concepts[cid] = Concept.get_by_id(cid)</pre></div>
<div class="nocov"><span class="num"><pre> 703</pre></span><pre>                return known_concepts[cid]</pre></div>
<div class="nocov"><span class="num"><pre> 704</pre></span><pre>            for c1, c2 in edges:</pre></div>
<div class="nocov"><span class="num"><pre> 705</pre></span><pre>                yield (get_concept(c1), get_concept(c2))</pre></div>
<div class="nocov"><span class="num"><pre> 706</pre></span><pre>        return list(edges_as_concept_objects(edges))</pre></div>
<div class="skip"><span class="num"><pre> 707</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 708</pre></span><pre>    class Meta:</pre></div>
<div class="cov"><span class="num"><pre> 709</pre></span><pre>        db_table = 'concepts'</pre></div>
<div class="cov"><span class="num"><pre> 710</pre></span><pre>        unique_together = ('language', 'text')</pre></div>
<div class="skip"><span class="num"><pre> 711</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre> 712</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 713</pre></span><pre>class UsefulAssertionManager(models.Manager):</pre></div>
<div class="cov"><span class="num"><pre> 714</pre></span><pre>    def get_query_set(self):</pre></div>
<div class="nocov"><span class="num"><pre> 715</pre></span><pre>        return super(UsefulAssertionManager, self).get_query_set().filter(</pre></div>
<div class="nocov"><span class="num"><pre> 716</pre></span><pre>            score__gt=0, concept1__visible=True, concept2__visible=True</pre></div>
<div class="nocov"><span class="num"><pre> 717</pre></span><pre>        )</pre></div>
<div class="skip"><span class="num"><pre> 718</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 719</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 720</pre></span><pre>class SurfaceForm(models.Model):</pre></div>
<div class="cov"><span class="num"><pre> 721</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 722</pre></span><pre>    A SurfaceForm is a string used to express a :class:`Concept` in its natural</pre></div>
<div class="cov"><span class="num"><pre> 723</pre></span><pre>    language.</pre></div>
<div class="cov"><span class="num"><pre> 724</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 725</pre></span><pre>    language = models.ForeignKey(Language)</pre></div>
<div class="cov"><span class="num"><pre> 726</pre></span><pre>    concept = models.ForeignKey(Concept)</pre></div>
<div class="cov"><span class="num"><pre> 727</pre></span><pre>    text = models.TextField()</pre></div>
<div class="cov"><span class="num"><pre> 728</pre></span><pre>    residue = models.TextField()</pre></div>
<div class="cov"><span class="num"><pre> 729</pre></span><pre>    use_count = models.IntegerField(default=0)</pre></div>
<div class="skip"><span class="num"><pre> 730</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 731</pre></span><pre>    @staticmethod</pre></div>
<div class="cov"><span class="num"><pre> 732</pre></span><pre>    def get(text, lang, auto_create=False):</pre></div>
<div class="cov"><span class="num"><pre> 733</pre></span><pre>        if isinstance(lang, basestring):</pre></div>
<div class="nocov"><span class="num"><pre> 734</pre></span><pre>            lang = Language.get(lang)</pre></div>
<div class="cov"><span class="num"><pre> 735</pre></span><pre>        nl = lang.nl</pre></div>
<div class="cov"><span class="num"><pre> 736</pre></span><pre>        try:</pre></div>
<div class="cov"><span class="num"><pre> 737</pre></span><pre>            known = SurfaceForm.objects.get(language=lang, text=text)</pre></div>
<div class="cov"><span class="num"><pre> 738</pre></span><pre>            return known</pre></div>
<div class="nocov"><span class="num"><pre> 739</pre></span><pre>        except SurfaceForm.DoesNotExist:</pre></div>
<div class="nocov"><span class="num"><pre> 740</pre></span><pre>            if not auto_create:</pre></div>
<div class="nocov"><span class="num"><pre> 741</pre></span><pre>                return None</pre></div>
<div class="nocov"><span class="num"><pre> 742</pre></span><pre>            else:</pre></div>
<div class="nocov"><span class="num"><pre> 743</pre></span><pre>                lemma, residue = nl.lemma_factor(text)</pre></div>
<div class="nocov"><span class="num"><pre> 744</pre></span><pre>                concept, created = Concept.objects.get_or_create(language=lang, text=lemma)</pre></div>
<div class="nocov"><span class="num"><pre> 745</pre></span><pre>                if created: concept.save()</pre></div>
<div class="skip"><span class="num"><pre> 746</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 747</pre></span><pre>                # use get_or_create so it's atomic</pre></div>
<div class="nocov"><span class="num"><pre> 748</pre></span><pre>                surface_form, _ = SurfaceForm.objects.get_or_create(concept=concept,</pre></div>
<div class="nocov"><span class="num"><pre> 749</pre></span><pre>                text=text, residue=residue, language=lang)</pre></div>
<div class="nocov"><span class="num"><pre> 750</pre></span><pre>                return surface_form</pre></div>
<div class="skip"><span class="num"><pre> 751</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 752</pre></span><pre>    def update_raw(self):</pre></div>
<div class="nocov"><span class="num"><pre> 753</pre></span><pre>        for raw in self.left_rawassertion_set.all():</pre></div>
<div class="nocov"><span class="num"><pre> 754</pre></span><pre>            raw.update_assertion()</pre></div>
<div class="nocov"><span class="num"><pre> 755</pre></span><pre>        for raw in self.right_rawassertion_set.all():</pre></div>
<div class="nocov"><span class="num"><pre> 756</pre></span><pre>            raw.update_assertion()</pre></div>
<div class="skip"><span class="num"><pre> 757</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 758</pre></span><pre>    def update(self, stem, residue):</pre></div>
<div class="nocov"><span class="num"><pre> 759</pre></span><pre>        self.concept = Concept.get_raw(stem, self.language, auto_create=True)</pre></div>
<div class="nocov"><span class="num"><pre> 760</pre></span><pre>        self.residue = residue</pre></div>
<div class="nocov"><span class="num"><pre> 761</pre></span><pre>        self.update_raw()</pre></div>
<div class="nocov"><span class="num"><pre> 762</pre></span><pre>        return self</pre></div>
<div class="skip"><span class="num"><pre> 763</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 764</pre></span><pre>    @property</pre></div>
<div class="cov"><span class="num"><pre> 765</pre></span><pre>    def urltext(self):</pre></div>
<div class="nocov"><span class="num"><pre> 766</pre></span><pre>        return urlquote(self.text)</pre></div>
<div class="skip"><span class="num"><pre> 767</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 768</pre></span><pre>    def __unicode__(self):</pre></div>
<div class="nocov"><span class="num"><pre> 769</pre></span><pre>        return self.text</pre></div>
<div class="skip"><span class="num"><pre> 770</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 771</pre></span><pre>    class Meta:</pre></div>
<div class="cov"><span class="num"><pre> 772</pre></span><pre>        db_table = 'surface_forms'</pre></div>
<div class="cov"><span class="num"><pre> 773</pre></span><pre>        unique_together = (('language', 'text'),)</pre></div>
<div class="cov"><span class="num"><pre> 774</pre></span><pre>        ordering = ['-use_count']</pre></div>
<div class="skip"><span class="num"><pre> 775</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 776</pre></span><pre>class Assertion(models.Model, ScoredModel):</pre></div>
<div class="skip"><span class="num"><pre> 777</pre></span><pre>    # Managers</pre></div>
<div class="cov"><span class="num"><pre> 778</pre></span><pre>    objects = models.Manager()</pre></div>
<div class="cov"><span class="num"><pre> 779</pre></span><pre>    useful = UsefulAssertionManager()</pre></div>
<div class="skip"><span class="num"><pre> 780</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 781</pre></span><pre>    language = models.ForeignKey(Language)</pre></div>
<div class="cov"><span class="num"><pre> 782</pre></span><pre>    relation = models.ForeignKey(Relation)</pre></div>
<div class="cov"><span class="num"><pre> 783</pre></span><pre>    concept1 = models.ForeignKey(Concept, related_name='left_assertion_set')</pre></div>
<div class="cov"><span class="num"><pre> 784</pre></span><pre>    concept2 = models.ForeignKey(Concept, related_name='right_assertion_set')</pre></div>
<div class="cov"><span class="num"><pre> 785</pre></span><pre>    score = models.IntegerField(default=0)</pre></div>
<div class="cov"><span class="num"><pre> 786</pre></span><pre>    frequency = models.ForeignKey(Frequency)</pre></div>
<div class="cov"><span class="num"><pre> 787</pre></span><pre>    votes = generic.GenericRelation(Vote)</pre></div>
<div class="skip"><span class="num"><pre> 788</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 789</pre></span><pre>    best_surface1 = models.ForeignKey(SurfaceForm, null=True, related_name='left_assertion_set')</pre></div>
<div class="cov"><span class="num"><pre> 790</pre></span><pre>    best_surface2 = models.ForeignKey(SurfaceForm, null=True, related_name='right_assertion_set')</pre></div>
<div class="cov"><span class="num"><pre> 791</pre></span><pre>    best_raw_id = models.IntegerField(null=True)</pre></div>
<div class="cov"><span class="num"><pre> 792</pre></span><pre>    best_frame = models.ForeignKey(Frame, null=True)</pre></div>
<div class="skip"><span class="num"><pre> 793</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 794</pre></span><pre>    class Meta:</pre></div>
<div class="cov"><span class="num"><pre> 795</pre></span><pre>        db_table = 'assertions'</pre></div>
<div class="cov"><span class="num"><pre> 796</pre></span><pre>        unique_together = ('relation', 'concept1', 'concept2', 'frequency', 'language')</pre></div>
<div class="cov"><span class="num"><pre> 797</pre></span><pre>        ordering = ['-score']</pre></div>
<div class="skip"><span class="num"><pre> 798</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 799</pre></span><pre>    def best_raw(self):</pre></div>
<div class="cov"><span class="num"><pre> 800</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 801</pre></span><pre>        Get the highest scoring :class:`RawAssertion` for this assertion.</pre></div>
<div class="cov"><span class="num"><pre> 802</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 803</pre></span><pre>        return self.rawassertion_set.all()[0]</pre></div>
<div class="skip"><span class="num"><pre> 804</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 805</pre></span><pre>    def nl_repr(self, wrap_text=lambda assertion, text: text):</pre></div>
<div class="skip"><span class="num"><pre> 806</pre></span><pre>        # FIXME: use the raw cache</pre></div>
<div class="nocov"><span class="num"><pre> 807</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 808</pre></span><pre>            return self.best_raw().nl_repr(wrap_text)</pre></div>
<div class="nocov"><span class="num"><pre> 809</pre></span><pre>        except ValueError:</pre></div>
<div class="nocov"><span class="num"><pre> 810</pre></span><pre>            raise ValueError(str(self))</pre></div>
<div class="nocov"><span class="num"><pre> 811</pre></span><pre>            return '%s %s %s' % (wrap_text(self, self.concept1.text),</pre></div>
<div class="nocov"><span class="num"><pre> 812</pre></span><pre>                                 self.relation.name,</pre></div>
<div class="nocov"><span class="num"><pre> 813</pre></span><pre>                                 wrap_text(self, self.concept2.text))</pre></div>
<div class="skip"><span class="num"><pre> 814</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 815</pre></span><pre>    def update_raw_cache(self):</pre></div>
<div class="nocov"><span class="num"><pre> 816</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 817</pre></span><pre>            best_raw = self.best_raw()</pre></div>
<div class="nocov"><span class="num"><pre> 818</pre></span><pre>        except IndexError: return</pre></div>
<div class="skip"><span class="num"><pre> 819</pre></span><pre>        </pre></div>
<div class="nocov"><span class="num"><pre> 820</pre></span><pre>        self.best_surface1 = best_raw.surface1</pre></div>
<div class="nocov"><span class="num"><pre> 821</pre></span><pre>        self.best_surface2 = best_raw.surface2</pre></div>
<div class="nocov"><span class="num"><pre> 822</pre></span><pre>        self.best_frame = best_raw.frame</pre></div>
<div class="nocov"><span class="num"><pre> 823</pre></span><pre>        self.best_raw_id = best_raw.id</pre></div>
<div class="nocov"><span class="num"><pre> 824</pre></span><pre>        self.save()</pre></div>
<div class="skip"><span class="num"><pre> 825</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre> 826</pre></span><pre>  </pre></div>
<div class="cov"><span class="num"><pre> 827</pre></span><pre>    @property</pre></div>
<div class="cov"><span class="num"><pre> 828</pre></span><pre>    def creator(self):</pre></div>
<div class="nocov"><span class="num"><pre> 829</pre></span><pre>        return self.best_raw().creator</pre></div>
<div class="skip"><span class="num"><pre> 830</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 831</pre></span><pre>    @property</pre></div>
<div class="cov"><span class="num"><pre> 832</pre></span><pre>    def polarity(self):</pre></div>
<div class="nocov"><span class="num"><pre> 833</pre></span><pre>        if self.frequency.value &gt;= 0: return 1</pre></div>
<div class="nocov"><span class="num"><pre> 834</pre></span><pre>        else: return -1</pre></div>
<div class="skip"><span class="num"><pre> 835</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 836</pre></span><pre>    def __unicode__(self):</pre></div>
<div class="skip"><span class="num"><pre> 837</pre></span><pre>        #return &quot;Assertion&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 838</pre></span><pre>        return u&quot;%s(%s, %s)[%s]&quot; % (self.relation.name, self.concept1.text,</pre></div>
<div class="nocov"><span class="num"><pre> 839</pre></span><pre>        self.concept2.text, self.frequency.text)</pre></div>
<div class="skip"><span class="num"><pre> 840</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 841</pre></span><pre>    @classmethod</pre></div>
<div class="cov"><span class="num"><pre> 842</pre></span><pre>    def get_filtered(cls, *a, **kw):</pre></div>
<div class="nocov"><span class="num"><pre> 843</pre></span><pre>        useful_only = kw.pop('useful_only', True)</pre></div>
<div class="nocov"><span class="num"><pre> 844</pre></span><pre>        if useful_only: return cls.useful.filter(*a, **kw)</pre></div>
<div class="nocov"><span class="num"><pre> 845</pre></span><pre>        else: return cls.objects.filter(*a, **kw)</pre></div>
<div class="skip"><span class="num"><pre> 846</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 847</pre></span><pre>    def get_absolute_url(self):</pre></div>
<div class="nocov"><span class="num"><pre> 848</pre></span><pre>        return '/%s/assertion/%s/' % (self.language.id, self.id)</pre></div>
<div class="skip"><span class="num"><pre> 849</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 850</pre></span><pre>class RawAssertion(TimestampedModel, ScoredModel):</pre></div>
<div class="cov"><span class="num"><pre> 851</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 852</pre></span><pre>    A RawAssertion represents the connection between an :class:`Assertion` and</pre></div>
<div class="cov"><span class="num"><pre> 853</pre></span><pre>    natural language. Where an Assertion describes a :class:`Relation` between</pre></div>
<div class="cov"><span class="num"><pre> 854</pre></span><pre>    two :class:`Concepts`, a RawAssertion describes a sentence :class:`Frame`</pre></div>
<div class="cov"><span class="num"><pre> 855</pre></span><pre>    that connects the :class:`SurfaceForms` of those concepts.</pre></div>
<div class="skip"><span class="num"><pre> 856</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 857</pre></span><pre>    A RawAssertion also represents how a particular :class:`Sentence` can</pre></div>
<div class="cov"><span class="num"><pre> 858</pre></span><pre>    be interpreted to make an Assertion. :attr:`surface1` and :attr:`surface2`</pre></div>
<div class="cov"><span class="num"><pre> 859</pre></span><pre>    generally come from chunks of a sentence that someone entered into Open</pre></div>
<div class="cov"><span class="num"><pre> 860</pre></span><pre>    Mind.</pre></div>
<div class="cov"><span class="num"><pre> 861</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 862</pre></span><pre>    sentence = models.ForeignKey(Sentence, null=True)</pre></div>
<div class="cov"><span class="num"><pre> 863</pre></span><pre>    assertion = models.ForeignKey(Assertion, null=True)</pre></div>
<div class="cov"><span class="num"><pre> 864</pre></span><pre>    creator = models.ForeignKey(User)</pre></div>
<div class="cov"><span class="num"><pre> 865</pre></span><pre>    surface1 = models.ForeignKey(SurfaceForm, related_name='left_rawassertion_set')</pre></div>
<div class="cov"><span class="num"><pre> 866</pre></span><pre>    surface2 = models.ForeignKey(SurfaceForm, related_name='right_rawassertion_set')</pre></div>
<div class="cov"><span class="num"><pre> 867</pre></span><pre>    frame = models.ForeignKey(Frame)    </pre></div>
<div class="skip"><span class="num"><pre> 868</pre></span><pre>    #batch = models.ForeignKey(Batch, null=True)</pre></div>
<div class="cov"><span class="num"><pre> 869</pre></span><pre>    language = models.ForeignKey(Language)</pre></div>
<div class="cov"><span class="num"><pre> 870</pre></span><pre>    score = models.IntegerField(default=0)</pre></div>
<div class="cov"><span class="num"><pre> 871</pre></span><pre>    votes = generic.GenericRelation(Vote)</pre></div>
<div class="skip"><span class="num"><pre> 872</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 873</pre></span><pre>    @property</pre></div>
<div class="nocov"><span class="num"><pre> 874</pre></span><pre>    def relation(self): return self.frame.relation</pre></div>
<div class="cov"><span class="num"><pre> 875</pre></span><pre>    @property</pre></div>
<div class="nocov"><span class="num"><pre> 876</pre></span><pre>    def text1(self): return self.surface1.text</pre></div>
<div class="cov"><span class="num"><pre> 877</pre></span><pre>    @property</pre></div>
<div class="nocov"><span class="num"><pre> 878</pre></span><pre>    def text2(self): return self.surface2.text</pre></div>
<div class="skip"><span class="num"><pre> 879</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 880</pre></span><pre>    def __unicode__(self):</pre></div>
<div class="nocov"><span class="num"><pre> 881</pre></span><pre>        return u&quot;%(language)s: ('%(text1)s' %(relation)s '%(text2)s') s=%(score)d&quot; % dict(</pre></div>
<div class="nocov"><span class="num"><pre> 882</pre></span><pre>            language=self.language.id, relation=self.relation.name,</pre></div>
<div class="nocov"><span class="num"><pre> 883</pre></span><pre>            text1=self.text1, text2=self.text2, score=self.score)</pre></div>
<div class="skip"><span class="num"><pre> 884</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 885</pre></span><pre>    def nl_repr(self, wrap_text=lambda assertion, text: text):</pre></div>
<div class="cov"><span class="num"><pre> 886</pre></span><pre>        &quot;&quot;&quot;Reconstruct the natural language representation.</pre></div>
<div class="cov"><span class="num"><pre> 887</pre></span><pre>        The text concepts are passed to the wrap_text function to</pre></div>
<div class="cov"><span class="num"><pre> 888</pre></span><pre>        allow a view to wrap them in a link (or do any other</pre></div>
<div class="cov"><span class="num"><pre> 889</pre></span><pre>        transformation.) The prototype for wrap_text is</pre></div>
<div class="cov"><span class="num"><pre> 890</pre></span><pre>        :samp:`wrap_text({assertion}, {text})`,</pre></div>
<div class="cov"><span class="num"><pre> 891</pre></span><pre>        where *assertion* is this RawAssertion object and *text* is the</pre></div>
<div class="cov"><span class="num"><pre> 892</pre></span><pre>        natural-language text of the concept (text1 or text2).&quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre> 893</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 894</pre></span><pre>        text1 = wrap_text(self, self.surface1.text.strip())</pre></div>
<div class="nocov"><span class="num"><pre> 895</pre></span><pre>        text2 = wrap_text(self, self.surface2.text.strip())</pre></div>
<div class="nocov"><span class="num"><pre> 896</pre></span><pre>        return self.frame.fill_in(text1, text2)</pre></div>
<div class="skip"><span class="num"><pre> 897</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 898</pre></span><pre>    def main_sentence(self):</pre></div>
<div class="nocov"><span class="num"><pre> 899</pre></span><pre>        return self.sentence</pre></div>
<div class="skip"><span class="num"><pre> 900</pre></span><pre>        #return self.sentences.all()[0]</pre></div>
<div class="skip"><span class="num"><pre> 901</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 902</pre></span><pre>    def surface(self, idx):</pre></div>
<div class="cov"><span class="num"><pre> 903</pre></span><pre>        &quot;&quot;&quot;Get either surface1 or surface2, depending on the (1-based) idx.&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 904</pre></span><pre>        if idx == 1: return self.surface1</pre></div>
<div class="nocov"><span class="num"><pre> 905</pre></span><pre>        elif idx == 2: return self.surface2</pre></div>
<div class="nocov"><span class="num"><pre> 906</pre></span><pre>        else: raise KeyError(idx)</pre></div>
<div class="skip"><span class="num"><pre> 907</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 908</pre></span><pre>    def update_assertion(self):</pre></div>
<div class="cov"><span class="num"><pre> 909</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 910</pre></span><pre>        Update the connection between this RawAssertion and its Assertion,</pre></div>
<div class="cov"><span class="num"><pre> 911</pre></span><pre>        if a Frame or SurfaceForm has changed.</pre></div>
<div class="cov"><span class="num"><pre> 912</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 913</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 914</pre></span><pre>            matching = Assertion.objects.get(</pre></div>
<div class="nocov"><span class="num"><pre> 915</pre></span><pre>                concept1=self.surface1.concept,</pre></div>
<div class="nocov"><span class="num"><pre> 916</pre></span><pre>                concept2=self.surface2.concept,</pre></div>
<div class="nocov"><span class="num"><pre> 917</pre></span><pre>                relation=self.frame.relation,</pre></div>
<div class="nocov"><span class="num"><pre> 918</pre></span><pre>                frequency=self.frame.frequency</pre></div>
<div class="nocov"><span class="num"><pre> 919</pre></span><pre>            )</pre></div>
<div class="nocov"><span class="num"><pre> 920</pre></span><pre>            if matching is self.assertion:</pre></div>
<div class="skip"><span class="num"><pre> 921</pre></span><pre>                # Nothing to be done</pre></div>
<div class="nocov"><span class="num"><pre> 922</pre></span><pre>                return self.assertion</pre></div>
<div class="skip"><span class="num"><pre> 923</pre></span><pre>            # There's an assertion like this already. Merge the two assertions.</pre></div>
<div class="nocov"><span class="num"><pre> 924</pre></span><pre>            for vote in self.assertion.votes.all():</pre></div>
<div class="nocov"><span class="num"><pre> 925</pre></span><pre>                nvotes = Vote.objects.filter(user=vote.user,</pre></div>
<div class="nocov"><span class="num"><pre> 926</pre></span><pre>                object_id=matching.id)</pre></div>
<div class="nocov"><span class="num"><pre> 927</pre></span><pre>                if nvotes == 0:</pre></div>
<div class="nocov"><span class="num"><pre> 928</pre></span><pre>                    vote.object = matching</pre></div>
<div class="nocov"><span class="num"><pre> 929</pre></span><pre>                    vote.save()</pre></div>
<div class="nocov"><span class="num"><pre> 930</pre></span><pre>            self.assertion.update_score()</pre></div>
<div class="nocov"><span class="num"><pre> 931</pre></span><pre>            self.assertion = matching</pre></div>
<div class="nocov"><span class="num"><pre> 932</pre></span><pre>            self.assertion.update_score()</pre></div>
<div class="nocov"><span class="num"><pre> 933</pre></span><pre>            self.save()</pre></div>
<div class="nocov"><span class="num"><pre> 934</pre></span><pre>            return self.assertion</pre></div>
<div class="nocov"><span class="num"><pre> 935</pre></span><pre>        except Assertion.DoesNotExist:</pre></div>
<div class="skip"><span class="num"><pre> 936</pre></span><pre>            # We can do this just by updating the existing assertion.</pre></div>
<div class="nocov"><span class="num"><pre> 937</pre></span><pre>            self.assertion.concept1 = self.surface1.concept</pre></div>
<div class="nocov"><span class="num"><pre> 938</pre></span><pre>            self.assertion.concept2 = self.surface2.concept</pre></div>
<div class="nocov"><span class="num"><pre> 939</pre></span><pre>            self.assertion.relation = self.frame.relation</pre></div>
<div class="nocov"><span class="num"><pre> 940</pre></span><pre>            self.assertion.save()</pre></div>
<div class="nocov"><span class="num"><pre> 941</pre></span><pre>            return self.assertion</pre></div>
<div class="skip"><span class="num"><pre> 942</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 943</pre></span><pre>    @staticmethod</pre></div>
<div class="cov"><span class="num"><pre> 944</pre></span><pre>    def make(user, frame, text1, text2, activity, vote=1):</pre></div>
<div class="cov"><span class="num"><pre> 945</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 946</pre></span><pre>        Create a RawAssertion and a corresponding :class:`Assertion`</pre></div>
<div class="cov"><span class="num"><pre> 947</pre></span><pre>        and :class:`Sentence` from user input. Assign votes appropriately.</pre></div>
<div class="skip"><span class="num"><pre> 948</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 949</pre></span><pre>        Requires the following arguments:</pre></div>
<div class="skip"><span class="num"><pre> 950</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 951</pre></span><pre>        - *user*: The user to credit the new assertion to.</pre></div>
<div class="cov"><span class="num"><pre> 952</pre></span><pre>        - *frame*: The :class:`Frame` that is being filled in.</pre></div>
<div class="cov"><span class="num"><pre> 953</pre></span><pre>        - *text1*: A string filling the first slot of the frame.</pre></div>
<div class="cov"><span class="num"><pre> 954</pre></span><pre>        - *text2*: A string filling the second slot of the frame.</pre></div>
<div class="cov"><span class="num"><pre> 955</pre></span><pre>        - *activity*: The event that produced this assertion.</pre></div>
<div class="cov"><span class="num"><pre> 956</pre></span><pre>        - *vote*: The user's vote on the assertion (often +1, but -1 can occur</pre></div>
<div class="cov"><span class="num"><pre> 957</pre></span><pre>          when the user is answering &quot;no&quot; to a question that has not been</pre></div>
<div class="cov"><span class="num"><pre> 958</pre></span><pre>          answered before).</pre></div>
<div class="cov"><span class="num"><pre> 959</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 960</pre></span><pre>        assert text1 != text2</pre></div>
<div class="nocov"><span class="num"><pre> 961</pre></span><pre>        lang = frame.language</pre></div>
<div class="nocov"><span class="num"><pre> 962</pre></span><pre>        surface1 = SurfaceForm.get(text1, lang, auto_create=True)</pre></div>
<div class="nocov"><span class="num"><pre> 963</pre></span><pre>        surface2 = SurfaceForm.get(text2, lang, auto_create=True)</pre></div>
<div class="skip"><span class="num"><pre> 964</pre></span><pre>        </pre></div>
<div class="nocov"><span class="num"><pre> 965</pre></span><pre>        raw_assertion, _ = RawAssertion.objects.get_or_create(</pre></div>
<div class="nocov"><span class="num"><pre> 966</pre></span><pre>            frame=frame,</pre></div>
<div class="nocov"><span class="num"><pre> 967</pre></span><pre>            surface1=surface1,</pre></div>
<div class="nocov"><span class="num"><pre> 968</pre></span><pre>            surface2=surface2,</pre></div>
<div class="nocov"><span class="num"><pre> 969</pre></span><pre>            language=lang,</pre></div>
<div class="nocov"><span class="num"><pre> 970</pre></span><pre>            creator=user,</pre></div>
<div class="nocov"><span class="num"><pre> 971</pre></span><pre>            defaults=dict(score=0)</pre></div>
<div class="nocov"><span class="num"><pre> 972</pre></span><pre>        )</pre></div>
<div class="nocov"><span class="num"><pre> 973</pre></span><pre>        raw_assertion.save()</pre></div>
<div class="skip"><span class="num"><pre> 974</pre></span><pre>        </pre></div>
<div class="nocov"><span class="num"><pre> 975</pre></span><pre>        assertion, _ = Assertion.objects.get_or_create(</pre></div>
<div class="nocov"><span class="num"><pre> 976</pre></span><pre>            relation=frame.relation,</pre></div>
<div class="nocov"><span class="num"><pre> 977</pre></span><pre>            concept1=surface1.concept,</pre></div>
<div class="nocov"><span class="num"><pre> 978</pre></span><pre>            concept2=surface2.concept,</pre></div>
<div class="nocov"><span class="num"><pre> 979</pre></span><pre>            frequency=frame.frequency,</pre></div>
<div class="nocov"><span class="num"><pre> 980</pre></span><pre>            language=lang,</pre></div>
<div class="nocov"><span class="num"><pre> 981</pre></span><pre>            defaults=dict(score=0)</pre></div>
<div class="nocov"><span class="num"><pre> 982</pre></span><pre>        )</pre></div>
<div class="nocov"><span class="num"><pre> 983</pre></span><pre>        assertion.save()</pre></div>
<div class="nocov"><span class="num"><pre> 984</pre></span><pre>        raw_assertion.assertion = assertion</pre></div>
<div class="skip"><span class="num"><pre> 985</pre></span><pre>        </pre></div>
<div class="nocov"><span class="num"><pre> 986</pre></span><pre>        sentence, c = Sentence.objects.get_or_create(</pre></div>
<div class="nocov"><span class="num"><pre> 987</pre></span><pre>            text=frame.fill_in(text1, text2),</pre></div>
<div class="nocov"><span class="num"><pre> 988</pre></span><pre>            creator=user,</pre></div>
<div class="nocov"><span class="num"><pre> 989</pre></span><pre>            language=lang,</pre></div>
<div class="nocov"><span class="num"><pre> 990</pre></span><pre>            activity=activity,</pre></div>
<div class="nocov"><span class="num"><pre> 991</pre></span><pre>            defaults=dict(score=0)</pre></div>
<div class="nocov"><span class="num"><pre> 992</pre></span><pre>        )</pre></div>
<div class="nocov"><span class="num"><pre> 993</pre></span><pre>        if c:</pre></div>
<div class="nocov"><span class="num"><pre> 994</pre></span><pre>            lang.sentence_count += 1</pre></div>
<div class="nocov"><span class="num"><pre> 995</pre></span><pre>            lang.save()</pre></div>
<div class="nocov"><span class="num"><pre> 996</pre></span><pre>            sentence.save()</pre></div>
<div class="skip"><span class="num"><pre> 997</pre></span><pre>                </pre></div>
<div class="nocov"><span class="num"><pre> 998</pre></span><pre>        Event.record_event(sentence, user, activity)</pre></div>
<div class="nocov"><span class="num"><pre> 999</pre></span><pre>        sentence.set_rating(user, vote, activity)</pre></div>
<div class="nocov"><span class="num"><pre>1000</pre></span><pre>        raw_assertion.set_rating(user, vote, activity)</pre></div>
<div class="nocov"><span class="num"><pre>1001</pre></span><pre>        Event.record_event(raw_assertion, user, activity)</pre></div>
<div class="nocov"><span class="num"><pre>1002</pre></span><pre>        assertion.set_rating(user, vote, activity)</pre></div>
<div class="nocov"><span class="num"><pre>1003</pre></span><pre>        Event.record_event(assertion, user, activity)</pre></div>
<div class="skip"><span class="num"><pre>1004</pre></span><pre>        </pre></div>
<div class="nocov"><span class="num"><pre>1005</pre></span><pre>        raw_assertion.sentence = sentence</pre></div>
<div class="nocov"><span class="num"><pre>1006</pre></span><pre>        raw_assertion.save()</pre></div>
<div class="nocov"><span class="num"><pre>1007</pre></span><pre>        return raw_assertion</pre></div>
<div class="skip"><span class="num"><pre>1008</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>1009</pre></span><pre>    def update_score(self):</pre></div>
<div class="nocov"><span class="num"><pre>1010</pre></span><pre>        ScoredModel.update_score(self)</pre></div>
<div class="nocov"><span class="num"><pre>1011</pre></span><pre>        self.assertion.update_raw_cache()</pre></div>
<div class="skip"><span class="num"><pre>1012</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>1013</pre></span><pre>    def get_absolute_url(self):</pre></div>
<div class="nocov"><span class="num"><pre>1014</pre></span><pre>        return '/%s/statement/%s/' % (self.language.id, self.id)</pre></div>
<div class="skip"><span class="num"><pre>1015</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>1016</pre></span><pre>    class Meta:</pre></div>
<div class="cov"><span class="num"><pre>1017</pre></span><pre>        db_table = 'raw_assertions'</pre></div>
<div class="cov"><span class="num"><pre>1018</pre></span><pre>        ordering = ['-score']</pre></div>
<div class="skip"><span class="num"><pre>1019</pre></span><pre></pre></div>
</div>
</body>
</html>
